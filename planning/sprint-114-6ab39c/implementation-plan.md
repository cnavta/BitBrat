# Implementation Plan – sprint-114-6ab39c

## Objective
- Analyze current `npm run bootstrap:service` generator and produce a prioritized, trackable backlog to modernize it to the current BaseServer and repository standards. No generator code changes will be merged until this plan is approved.

## Scope
- In scope:
  - Review current generator outputs: app source, tests, Dockerfile, docker-compose snippet.
  - Compare against current standards in src/common/base-server.ts and representative services.
  - Define a concrete backlog of changes with acceptance criteria.
- Out of scope:
  - Implementing the generator changes (planned for next step after approval).
  - Deleting legacy services (e.g., llm-bot) – tracked but not executed in this phase.

## Deliverables
- Planning artifacts in planning/sprint-114-6ab39c/:
  - implementation-plan.md (this document)
  - request-log.md (running log)
  - validate_deliverable.sh (logical script to validate repo state)
  - verification-report.md (to be filled during/after verification)
  - publication.yaml (PR metadata; to be finalized on publish)
  - retro.md, key-learnings.md (to be filled at sprint end)
- A prioritized backlog of generator updates with clear acceptance criteria.

## Acceptance Criteria
- Backlog lists actionable items aligned with architecture.yaml and BaseServer.
- Items are prioritized and traceable, with explicit success conditions.
- Plan clearly states the chosen service pattern: Subclass BaseServer.
- validate_deliverable.sh is logically passable on this repo.

## Testing Strategy
- Unit tests for generator functions (retain and extend infrastructure/scripts/bootstrap-service.test.js) reflecting new patterns.
- Snapshot-like asserts for generated TypeScript, Dockerfile, and compose YAML strings.
- Integration smoke: run generator in a temp dir (mock fs) in future implementation sprint.

## Deployment Approach
- No deployment in this analysis sprint. Future sprints will update Dockerfiles and compose files generated by the tool; Cloud Run deployment path remains unchanged.

## Dependencies
- architecture.yaml structure (services, defaults.services.env, per-service env/secrets, entry path, paths)
- BaseServer API (ensureRequiredEnv, start, resources, logging, health endpoints)

## Definition of Done
- Backlog completed (analysis-only) and approved by user.
- Artifacts created and committed to feature branch.

---

## Findings Summary

- Current generator (infrastructure/scripts/bootstrap-service.js) emits:
  - src/apps/<service>-service.ts with an inline BaseServer instance and setup callback
  - Jest test co-located next to entry
  - Dockerfile.<service> (Node 24) that runs compiled dist entry
  - Compose file: infrastructure/docker-compose/services/<service>.compose.yaml
- Current standard in repo favors Subclassing BaseServer (e.g., auth, ingress-egress, event-router, oauth, command-processor). llm-bot is an exception and flagged for deletion.
- BaseServer provides: health endpoints, ensureRequiredEnv, resources via managers, logger, start().
- Generated services currently call app.listen directly instead of BaseServer.start().

---

## Backlog (Prioritized)

1) Switch generator to Subclass BaseServer pattern (P0)
   - Generate class <PascalServiceName>Server extends BaseServer
   - In constructor: super({ serviceName: SERVICE_NAME }); invoke private async setupApp(app, cfg)
   - Export createApp() that constructs the subclass and returns getApp()
   - Main guard: call BaseServer.ensureRequiredEnv(SERVICE_NAME), then use server.start(PORT) rather than app.listen
   Acceptance:
   - Generated file compiles and mirrors patterns in src/apps/auth-service.ts (structure and naming adjusted per service)

2) Align environment validation and health endpoints (P0)
   - Ensure generated main uses BaseServer.ensureRequiredEnv(SERVICE_NAME)
   - Rely on BaseServer default health endpoints (/healthz, /readyz, /livez) and root
   Acceptance:
   - Generated tests cover /healthz, /readyz, /livez

3) Incorporate resource access pattern stubs (P1)
   - Provide commented examples to access publisher and firestore via this.getResource<T>()
   - Avoid direct imports of bus/firestore in the template by default; keep minimal
   Acceptance:
   - Template compiles without additional deps; comments guide usage

4) Update Jest test template (P1)
   - Keep co-located test referencing createApp()
   - Maintain stub path tests; ensure wildcard/params normalization
   - Ensure tests do not require external services (NODE_ENV test and MESSAGE_BUS_DISABLE_SUBSCRIBE guidance)
   Acceptance:
   - bootstrap-service.test.js updated to reflect new structure and passes

5) Dockerfile template refinements (P1)
   - Keep Node 24 base images
   - Ensure architecture.yaml copied for BaseServer env computation
   - Prefer CMD ["node", "dist/apps/<entry>.js"]
   Acceptance:
   - Generated Dockerfile mirrors existing Dockerfile.llm-bot layout

6) Compose file template alignment (P2)
   - Validate env_file .env.local and GOOGLE_APPLICATION_CREDENTIALS mount
   - Ports mapping retains ${SERVICE}_HOST_PORT pattern
   - Optionally include depends_on for nats/firebase-emulator (consistent with deploy-local.sh)
   Acceptance:
   - deploy-local.sh recognizes generated compose file

7) CLI UX improvements (P2)
   - Ensure --name maps to architecture.yaml services key; error if missing
   - Add --dry-run to print planned files without writing
   - Add --overwrite-suffix or retain --force behavior
   Acceptance:
   - bootstrap-service.js supports new flags; help text updated

8) Documentation (P2)
   - Update README or docs section: how to use bootstrap:service, required envs, next steps
   - Reference architecture.yaml precedence
   Acceptance:
   - Docs PR section drafted

9) Migration notes (P3)
   - Mark inline setup pattern as deprecated; identify services to regenerate (e.g., llm-bot)
   - Provide steps to replace app.listen with server.start in existing entries (if any)
   Acceptance:
   - migration notes added under documentation/

---

## Next Steps After Approval
- Implement backlog items 1–5 in the generator with tests; then handle 6–9.
- Run validate_deliverable.sh and update verification-report.md.
