version: 1
sprint_id: sprint-119-a8827e
generated_at: 2025-12-06T17:55:00-05:00
owner_role: Lead Implementor
description: >-
  Prioritized, trackable backlog for incorporating routing slip helpers (`next(event)`,
  `complete(event)`) into BaseServer with method-level idempotency, and migrating
  command-processor to use them. Derived from technical-architecture.md.

conventions:
  priority_scale:
    - P0  # critical path for this sprint
    - P1  # important, should complete this sprint if time permits
    - P2  # stretch or follow-up
  status_values: [todo, in-progress, blocked, review, done]
  estimate_unit: points

backlog:
  - id: BL-001
    title: Draft Implementation Plan (implementation-plan.md) for sprint approval
    type: doc
    priority: P0
    status: done
    estimate: 2
    depends_on: []
    acceptance:
      - Plan covers scope, deliverables, acceptance criteria, testing, deployment per AGENTS.md
      - User explicitly approves the Implementation Plan before any code changes
    trace:
      - planning/sprint-119-a8827e/technical-architecture.md

  - id: BL-002
    title: Add validate_deliverable.sh (sprint-local) aligned with project DoD
    type: ci
    priority: P0
    status: done
    estimate: 2
    depends_on: [BL-001]
    acceptance:
      - Script installs deps, builds, runs tests, starts local (if applicable), healthchecks, shuts down
      - References existing npm scripts from package.json and is logically passable

  - id: BL-003
    title: Implement BaseServer protected helper next(event) with idempotency
    type: code
    priority: P0
    status: in-progress
    estimate: 5
    depends_on: [BL-001]
    acceptance:
      - Method finds first pending routing step and publishes to subject with attributes
      - Fallback to egressDestination when no pending steps (configurable future toggle)
      - Method-level idempotency guard prevents duplicate publish for same in-memory event instance
      - Tracing span routing.next emitted; logs at info/debug appropriately
      - No mutation beyond attempts/startedAt on selected step
    trace:
      - src/common/base-server.ts
      - src/services/message-bus/index.ts

  - id: BL-004
    title: Implement BaseServer protected helper complete(event) with idempotency
    type: code
    priority: P0
    status: in-progress
    estimate: 3
    depends_on: [BL-001]
    acceptance:
      - Publishes directly to egressDestination when present
      - No routingSlip status modifications
      - Method-level idempotency guard prevents duplicate publish for same in-memory event instance
      - Tracing span routing.complete emitted; logs at info/debug appropriately

  - id: BL-005
    title: Unit tests for BaseServer helpers (using test subclass + noop bus)
    type: test
    priority: P0
    status: todo
    estimate: 5
    depends_on: [BL-003, BL-004]
    acceptance:
      - next(event) publishes to first pending step subject with correct attributes
      - next(event) falls back to egressDestination when no pending steps
      - complete(event) publishes to egressDestination; warns when absent
      - Both methods are idempotent (second call is a no-op); markers cleared on publish failure to allow retry
      - Tracing attribute injection verified via spy/mocks

  - id: BL-006
    title: Refactor command-processor to call BaseServer.next/complete
    type: code
    priority: P0
    status: todo
    estimate: 3
    depends_on: [BL-003, BL-004, BL-005]
    acceptance:
      - Remove duplicated routing slip forwarding logic from command-processor
      - Processor uses BaseServer helpers; behavior unchanged and tests pass

  - id: BL-007
    title: Documentation updates (service guidelines + README notes)
    type: doc
    priority: P1
    status: todo
    estimate: 2
    depends_on: [BL-003, BL-004]
    acceptance:
      - Document how services should advance/complete routing using BaseServer helpers
      - Note idempotency expectations and attribute propagation

  - id: BL-008
    title: Observability polish for routing spans and logs
    type: code
    priority: P1
    status: todo
    estimate: 2
    depends_on: [BL-003, BL-004]
    acceptance:
      - Ensure span names/attributes match TA (routing.next, routing.complete)
      - Ensure log fields include correlationId, subject/egressDestination, stepIndex

  - id: BL-009
    title: Update validate_deliverable.sh to run targeted tests for helpers
    type: ci
    priority: P1
    status: todo
    estimate: 1
    depends_on: [BL-005]
    acceptance:
      - Script executes unit tests for BaseServer helpers and reports success

  - id: BL-010
    title: Publication (PR) for feature branch per AGENTS.md
    type: ops
    priority: P0
    status: todo
    estimate: 1
    depends_on: [BL-002, BL-006, BL-007]
    acceptance:
      - All changed files committed on feature/sprint-119-a8827e-routing-slip-baseserver
      - PR created via gh CLI; URL recorded in publication.yaml

  - id: BL-011
    title: Service migrations (router, auth, bot) to use BaseServer helpers
    type: code
    priority: P2
    status: todo
    estimate: 8
    depends_on: [BL-003, BL-004, BL-006]
    acceptance:
      - Identify and optionally stub migration for non-command services; defer if out of sprint scope

labels:
  - routing-slip
  - base-server
  - idempotency
  - observability
  - sprint-119-a8827e
