# Prioritized, Trackable YAML Backlog — sprint-123-a2f701b

version: 1
generatedAt: "2025-12-10T00:13:30Z"
owner: "Lead Implementor"
sprint: "sprint-123-a2f701b"

definitions:
  statuses: [todo, in-progress, blocked, review, done, deferred]
  priorities:
    - P0 # critical path for acceptance
    - P1 # important this sprint
    - P2 # nice to have / stretch

items:
  - id: STM-001
    title: "Establish LangGraph state shape and messages reducer"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: []
    acceptance:
      - Reducer appends messages and trims by max count and max chars
      - Defaults: maxMessages=8, maxChars=8000 (env-overridable)
      - Unit tests cover append and trimming

  - id: STM-002
    title: "Add ingest_prompt node to build HumanMessage from annotations"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001]
    acceptance:
      - Annotations transformed into a single user message and appended via reducer
      - When no annotations exist, graph exits early with SKIP
      - Debug logs include message counts before/after

  - id: STM-003
    title: "Update call_model to use messages and append AssistantMessage"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001, STM-002]
    acceptance:
      - Messages flattened into a single input string for model call
      - Assistant output appended as AssistantMessage
      - Debug logs record message length and char estimate

  - id: STM-004
    title: "Add build_candidate node to emit text candidate from assistant reply"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: [STM-003]
    acceptance:
      - CandidateV1 created with last assistant content
      - Backward compatibility fields (llmText/combinedPrompt) maintained

  - id: STM-005
    title: "Environment configuration for memory limits"
    priority: P1
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001]
    acceptance:
      - Reads LLM_BOT_MEMORY_MAX_MESSAGES and LLM_BOT_MEMORY_MAX_CHARS with defaults
      - Documented in README/planning

  - id: STM-006
    title: "Unit tests: reducer"
    priority: P0
    status: done
    owner: Quality Lead
    dependsOn: [STM-001]
    acceptance:
      - Tests pass for append and trimming scenarios

  - id: STM-007
    title: "Unit tests: processor memory behavior"
    priority: P0
    status: done
    owner: Quality Lead
    dependsOn: [STM-002, STM-003, STM-004]
    acceptance:
      - Happy path validates flattened input includes prior turns
      - Skip path: no annotations => SKIP and no candidate
      - Error path: injected model failure => ERROR and logs

  - id: STM-008
    title: "Observability logs for memory operations"
    priority: P1
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001, STM-003]
    acceptance:
      - Logs include before/after counts and trim metrics
      - Model input size logged (message count and chars)

  - id: STM-009
    title: "Validation script alignment"
    priority: P1
    status: done
    owner: Lead Implementor
    dependsOn: [STM-006, STM-007]
    acceptance:
      - validate_deliverable.sh runs build and tests successfully locally

  - id: STM-010
    title: "Documentation updates (planning notes and usage)"
    priority: P2
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001, STM-003, STM-004]
    acceptance:
      - Planning notes describe env vars and behavior
      - Short usage note for developers

milestones:
  - id: M1
    title: "Memory core operational"
    includes: [STM-001, STM-002, STM-003, STM-004]
    exitCriteria:
      - End-to-end flow produces candidate using short-term memory

  - id: M2
    title: "Tested and validated"
    includes: [STM-006, STM-007, STM-009]
    exitCriteria:
      - All unit tests pass via validation script

  - id: M3
    title: "Docs and observability"
    includes: [STM-005, STM-008, STM-010]
    exitCriteria:
      - Env and logs documented; debug logs visible in local runs

  # Phase 2 — Instance-Scoped Memory (cross-event within process lifetime)
  - id: STM-011
    title: "Implement InstanceMemoryStore (in-process)"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: [STM-001]
    acceptance:
      - Store supports per-key turns[], TTL eviction, LRU by maxKeys
      - Per-key trim by message count and char budget
      - Singleton accessor via getInstanceMemoryStore()

  - id: STM-012
    title: "Integrate store into processor (load/append)"
    priority: P0
    status: done
    owner: Lead Implementor
    dependsOn: [STM-011, STM-002, STM-003]
    acceptance:
      - ingest_prompt prepends prior turns from store for key
      - call_model appends assistant turn on success; user turns appended on ingest
      - Keying: `${channel}:${userId||anon}`

  - id: STM-013
    title: "Unit tests: store behavior (TTL/LRU/concurrency)"
    priority: P0
    status: done
    owner: Quality Lead
    dependsOn: [STM-011]
    acceptance:
      - Tests cover count/char trimming, TTL expiry, LRU eviction, per-key lock ordering

  - id: STM-014
    title: "Unit tests: processor across events using instance store"
    priority: P0
    status: done
    owner: Quality Lead
    dependsOn: [STM-012]
    acceptance:
      - Second event for same key includes prior turns in flattened input
      - Different keys remain isolated
      - Empty assistant reply does not add assistant turn to store

  - id: STM-015
    title: "Configuration: add LLM_BOT_INSTANCE_MEM_* env vars"
    priority: P1
    status: done
    owner: Lead Implementor
    dependsOn: [STM-011]
    acceptance:
      - architecture.yaml lists env vars for max keys/msg/chars and TTL

  - id: STM-016
    title: "Observability: instance memory logs"
    priority: P2
    status: done
    owner: Lead Implementor
    dependsOn: [STM-012]
    acceptance:
      - Logs on read/append errors; debug counts after append

  - id: STM-017
    title: "Docs: planning notes update for instance memory"
    priority: P2
    status: todo
    owner: Lead Implementor
    dependsOn: [STM-011, STM-012]
    acceptance:
      - Implementation plan updated; env knobs documented; caveats listed

  - id: STM-018
    title: "Validation: run scoped tests for llm-bot"
    priority: P1
    status: done
    owner: Lead Implementor
    dependsOn: [STM-013, STM-014]
    acceptance:
      - ./validate_deliverable.sh --scope llm-bot passes locally
