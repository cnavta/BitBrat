meta:
  backlog_id: tool-gateway-sprint-257
  updated_at: 2026-02-23
  status_values: [todo, in_progress, blocked, done]

sprint:
  id: sprint-257-a1b2c3
  start: 2026-02-23
  end: 2026-03-09
  wip_limit: 3
  goal: "Bootstrap Tool Gateway with dynamic discovery, RBAC, and proxying capabilities."

items:
  - id: TG-001
    title: "Refactor MCP core to common"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: []
    acceptance:
      - "McpClientManager and McpBridge moved to src/common/mcp/"
      - "llm-bot still builds and passes tests using the new paths"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T12:55:00Z
        note: "Moved MCP core to src/common/mcp; updated imports across code and tests; build + targeted tests green."

  - id: TG-002
    title: "Implement Tool Gateway Service Shell"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [TG-001]
    acceptance:
      - "src/apps/tool-gateway.ts exists"
      - "Responds to /health and basic MCP SSE endpoints"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T12:56:00Z
        note: "Starting implementation: update tool-gateway to extend McpServer and expose /sse, /message, /health."
      - at: 2026-02-23T12:58:00Z
        note: "Completed shell implementation: ToolGatewayServer extends McpServer and has /health. Verified with tool-gateway.test.ts."

  - id: TG-003
    title: "RegistryWatcher for Firestore"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [TG-002]
    acceptance:
      - "Watches mcp_servers collection"
      - "Calls McpClientManager to connect/disconnect based on snapshot changes"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:05:00Z
        note: "Implemented RegistryWatcher, moved Firestore logic out of McpClientManager, and updated llm-bot to use the new architecture. Verified with tests."

  - id: TG-004
    title: "Session-Scoped MCP Filtering & RBAC"
    priority: P1
    status: done
    effort: L
    owner: agent
    deps: [TG-003]
    acceptance:
      - "JWT claims correctly parsed for user roles"
      - "listTools returns different results for different roles/agents"
      - "Per-connection Server instances managed correctly"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:18:00Z
        note: "Implemented per-session MCP Server with RBAC filtering; added RbacEvaluator and SessionContext; originServer tagging; JWT/x-agent-name extraction. Added unit tests for RBAC. All targeted tests passing."

  - id: TG-005
    title: "Invocation Proxy implementation"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [TG-004]
    acceptance:
      - "Tool calls from agent are proxied to correct upstream server"
      - "Results are streamed back successfully"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:25:00Z
        note: "Implemented ProxyInvoker with timeout and circuit breaking; integrated into McpBridge and McpClientManager; added unit tests; targeted MCP tests passed; gateway now proxies tool invocations via upstream clients."

  - id: TG-006
    title: "Non-Agent HTTP Proxy Endpoints"
    priority: P2
    status: done
    effort: M
    owner: agent
    deps: [TG-005]
    acceptance:
      - "REST API available for tool calls and resource reads"
      - "Uses same RBAC logic as MCP path"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:30:00Z
        note: "Implemented REST endpoints /v1/tools, /v1/tools/:id, and /v1/resources with RBAC filtering. Enhanced registry and bridge to support resources and prompts. Verified with unit tests."

  - id: TG-007
    title: "Observability: Metrics & Usage Logs"
    priority: P1
    status: done
    effort: M
    owner: agent
    deps: [TG-005]
    acceptance:
      - "tool_usage collection populated on every call"
      - "OTel metrics exported for latency and status"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:35:00Z
        note: "Implemented McpObservability for Firestore audit logging (tool_usage) and OTel metrics. Integrated into ProxyInvoker to capture all tool, resource, and prompt calls. Updated all interfaces to propagate session context. Verified with tests."

  - id: TG-008
    title: "Final Validation & Agent Migration"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [TG-007]
    acceptance:
      - "llm-bot successfully uses tool-gateway as its only MCP server"
      - "Validation script passes for all components"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T18:40:00Z
        note: "Updated llm-bot to support MCP_GATEWAY_URL for direct connection to the Tool Gateway. Updated validate_deliverable.sh with tool-gateway scope and dry-run deployment validation. Verified all components with tests."

  - id: TG-009
    title: "Fix Stdio Transport Validation in Tool Gateway"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [TG-002]
    acceptance:
      - "McpClientManager provides detailed error on missing command"
      - "RegistryWatcher validates server config before connecting"
    updated_at: 2026-02-23
    log:
      - at: 2026-02-23T19:20:00Z
        note: "Remediated 'Stdio transport requires a command' error by adding pre-validation in RegistryWatcher and enhancing error reporting in McpClientManager. Added reproduction tests."
