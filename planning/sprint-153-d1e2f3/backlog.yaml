meta:
  backlog_id: sprint-153-backlog
  updated_at: 2025-12-21
  status_values: [todo, in_progress, blocked, done]

sprint:
  id: sprint-153-d1e2f3
  start: 2025-12-21
  end: 2026-01-04
  wip_limit: 3
  goal: "Establish platform-wide awareness of ingress source status and stream status in Firestore."

items:
  - id: BL-153-01
    title: "Foundation: Contracts & Schema"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: []
    blocked_reason: null
    acceptance:
      - "InternalEventV2 extended with system.source.status, system.stream.online, system.stream.offline"
      - "Firestore 'sources' collection schema defined in TypeScript"
      - "Normalization helpers added to persistence model"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T12:40:00Z
        note: "Contracts extended and schema defined."

  - id: BL-153-02
    title: "Ingress Connectivity Heartbeats"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [BL-153-01]
    blocked_reason: null
    acceptance:
      - "ingress-egress service emits system.source.status events periodically"
      - "Immediate status update on connector ERROR or DISCONNECTED"
      - "Heartbeats include basic metrics (messagesIn, messagesOut)"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T12:50:00Z
        note: "Heartbeat logic added to ingress-egress-service.ts."

  - id: BL-153-03
    title: "Twitch Stream Lifecycle Integration"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [BL-153-01]
    blocked_reason: null
    acceptance:
      - "TwitchEventSubClient subscribes to stream.online and stream.offline"
      - "Twitch events are mapped to InternalEventV2 and published to internal bus"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:00:00Z
        note: "EventSub subscriptions for stream.online/offline implemented."

  - id: BL-153-04
    title: "State Persistence to Firestore"
    priority: P0
    status: done
    effort: M
    owner: agent
    deps: [BL-153-02, BL-153-03]
    blocked_reason: null
    acceptance:
      - "persistence service updates 'sources' collection on system events"
      - "Firestore document ID follows {platform}:{id} format"
      - "Metrics are aggregated correctly in the source document"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:10:00Z
        note: "PersistenceStore extended to handle 'sources' collection."

  - id: BL-153-05
    title: "Enhanced Metrics: Auth & Viewers"
    priority: P1
    status: done
    effort: M
    owner: agent
    deps: [BL-153-04]
    blocked_reason: null
    acceptance:
      - "Authentication health status (VALID/EXPIRED/REVOKED) tracked in Firestore"
      - "Viewer count updated periodically while stream is ONLINE"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:15:00Z
        note: "Auth status tracking added to heartbeat loop."

  - id: BL-153-06
    title: "Advanced Metrics: Permissions & Latency"
    priority: P2
    status: done
    effort: S
    owner: agent
    deps: [BL-153-04]
    blocked_reason: null
    acceptance:
      - "Bot permissions (MODERATOR, etc.) stored in source metadata"
      - "Average latency tracked and updated in Firestore"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:20:00Z
        note: "Permissions and latency handled via generic metadata support in status updates."

  - id: BL-153-07
    title: "Remove Heartbeat Noise"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [BL-153-02]
    blocked_reason: null
    acceptance:
      - "Periodic system.source.status publication removed from ingress-egress-service"
      - "Pub/Sub noise reduced"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:05:00Z
        note: "Removed heartbeat loop to satisfy user request regarding noise."

  - id: BL-153-08
    title: "Fix EventSub Stream Online Crash"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [BL-153-03]
    blocked_reason: null
    acceptance:
      - "buildStreamOnline uses startDate from Twurple"
      - "Try-catch blocks added to all EventSub handlers"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T13:35:00Z
        note: "Fixed crash in stream.online handler and added defensive error handling."

  - id: BL-153-09
    title: "Restore Firestore Persistence for Source State"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [BL-153-04, BL-153-07]
    blocked_reason: null
    acceptance:
      - "normalizeStreamEvent includes platform and id"
      - "system.source.status published on state change in ingress-egress"
      - "Verified persistence of stream status via tests"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T14:10:00Z
        note: "Fixed missing fields in persistence model and re-introduced event-driven status updates."

  - id: BL-153-10
    title: "Fix EventSub ERROR state in Firestore"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [BL-153-03, BL-153-09]
    blocked_reason: null
    acceptance:
      - "TwitchEventSubClient tracks connection state"
      - "TwitchEventSubClient snapshot includes state, userId, and displayName"
      - "TwitchConnectorAdapter correctly maps EventSub state (not defaulting to ERROR)"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T14:20:00Z
        note: "Added state tracking to TwitchEventSubClient to fix incorrect ERROR status in Firestore."

  - id: BL-153-11
    title: "Fix Twitch Bot Token Overwrite"
    priority: P0
    status: done
    effort: S
    owner: agent
    deps: [BL-153-03]
    blocked_reason: null
    acceptance:
      - "FirestoreTwitchCredentialsProvider routes refreshed tokens to correct stores based on userId"
      - "Aliased bot tokens do not overwrite bot userId in Firestore"
      - "TWITCH_BOT_USER_ID supported as safeguard for corrupted Firestore docs"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T15:30:00Z
        note: "Implemented logic to distinguish between bot and broadcaster refreshes, protecting bot identity."

  - id: BL-153-12
    title: "Adjust Default OAuth Scopes for Twitch Bot"
    priority: P1
    status: done
    effort: S
    owner: agent
    deps: [BL-153-01]
    blocked_reason: null
    acceptance:
      - "Default Twitch scopes include moderator:read:followers (EventSub follow v2)"
      - "Default Twitch scopes include moderation:read (Bot permission check)"
      - "Default Twitch scopes include bits:read and moderator:read:shoutouts (Supported EventTypes)"
      - "TWITCH_OAUTH_SCOPES added to architecture.yaml"
    updated_at: 2025-12-21
    log:
      - at: 2025-12-21T15:45:00Z
        note: "Updated default scope lists in twitch-adapter.ts and twitch-oauth.ts. Added to architecture.yaml."
