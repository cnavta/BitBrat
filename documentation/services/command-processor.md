Command Processor Service

Date: 2025-12-01
Sprint: sprint-108-bc7a2d
Entry: src/apps/command-processor-service.ts

Overview
- Consumes internal.command.v1 events
- Detects commands with a configurable sigil (default "!")
- Resolves commands from Firestore by canonical name or alias
- Enforces optional global cooldown, per-user cooldown, and fixed-window rate limit
- Renders a response from a command template and appends it as a CandidateV1
- Advances the routing slip to the next step using BaseServer helpers, or publishes to egressDestination if none remain

Environment Variables
- COMMAND_SIGIL: Leading character denoting a command (default: !)
- BOT_USERNAME: Bot display name for rendering
- COMMANDS_COLLECTION: Firestore collection name for commands (default: commands)
- DEFAULT_GLOBAL_COOLDOWN_MS: Default global cooldown in ms (0 disables)
- DEFAULT_USER_COOLDOWN_MS: Default per-user cooldown in ms (0 disables)
- DEFAULT_RATE_MAX: Default max executions per window (0 disables)
- DEFAULT_RATE_PER_MS: Default window length in ms (default: 60000)
- LOG_LEVEL, MESSAGE_BUS_DRIVER, NATS_URL, BUS_PREFIX: Standard messaging/logging envs

Firestore Schema (first pass)
Collection: commands (root)
- id: auto-generated by Firestore
- name: string (canonical lowercase)
- description?: string
- aliases?: string[] (lowercase)
- templates: { id: string; text: string }[]
- cooldowns?: { globalMs?: number; perUserMs?: number }
- rateLimit?: { max: number; perMs: number }
- runtime?: { lastUsedTemplateId?: string; lastExecutionAt?: string }

Subcollections (runtime state)
- cooldowns/users/{userId}: { lastExecutionAt: string }
- rate-limits/windows/{windowKey}: { count: number, windowStartAt: string }

Indexes
- See documentation/firestore/indexes.md. Only single-field and array-contains are needed for current queries:
  - where name == <commandName>
  - where aliases array-contains <commandName>

Behavior
1) Parsing & Lookup
- If the message text does not start with COMMAND_SIGIL → mark current step SKIP and advance.
- Otherwise parse command name (lowercased) and args; lookup by name, then by alias.

2) Policies (transactional)
- Per-user cooldown: gate by cooldowns/users/{userId}.lastExecutionAt
- Rate limit: fixed-window counter under rate-limits/windows/{windowKey}
- Global cooldown: gate by runtime.lastExecutionAt; when allowed, persist lastExecutionAt and lastUsedTemplateId

3) Template rendering
- Choose randomly, avoiding lastUsedTemplateId when possible
- Render variables: {{botName}}, {{username}}, {{utcNow}}

4) Candidate
- kind: text; source: command-processor; status: proposed; priority: 100
- metadata includes: commandName, templateId, args, checks { globalCooldownMs, perUserMs, rate { max, perMs } }

5) Routing advancement
- Set current step status=OK (or SKIP on no-op/violations) and endedAt
- Use BaseServer protected helpers to advance:
  - `next(event)`: prefers the most recently completed step’s `nextTopic`, otherwise the first pending step; if none remain, falls back to `egressDestination`.
  - `complete(event)`: bypasses routing slip and publishes directly to `egressDestination`.
- Both helpers are idempotent per in-memory event instance; repeated calls are no-ops unless prior publish failed.

Logging (structured)
- command_processor.event.received
- command_processor.command.matched / command_processor.command.not_found
- command_processor.policy.blocked (GLOBAL_COOLDOWN | USER_COOLDOWN | RATE_LIMIT)
- command_processor.template.chosen
- command_processor.candidate.added
- command_processor.advance.next / .egress / .complete
- command_processor.process_error

Testing
- Unit tests cover parsing, repo lookups, policies, template selection/rendering, candidate creation, routing advancement
- Integration smoke test verifies V1→V2 normalization and candidate append

See also
- documentation/services/base-server-routing.md — details, usage, and idempotency of routing helpers.

Security
- Uses Firebase Admin (server credentials)
- Rendered output is treated as plain text; no code execution or HTML interpretation
