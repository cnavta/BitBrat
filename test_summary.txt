
> bitbrat-platform@1.0.0 test
> jest

PASS src/common/logging.test.ts
PASS src/services/auth/__tests__/user-repo.spec.ts
PASS src/common/__tests__/base-server-helpers.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:14.051Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.074Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.074Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.075Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/ping"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.076Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/echo"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.093Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.094Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.094Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/auth/__tests__/enrichment.spec.ts
PASS tests/apps/command-processor-error-policy.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:14.046Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.082Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.082Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.083Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.083Z","service":"command-processor","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.085Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.086Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.086Z","service":"command-processor","level":"info","severity":"INFO","msg":"regex_cache.start"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.205Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.regex_cache.started"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.206Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.206Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.206Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.error
      {"ts":"2025-12-19T19:57:14.245Z","service":"command-processor","level":"error","severity":"ERROR","msg":"base_server.message.handler_error","subject":"dev.internal.command.v1","error":"Expected property name or '}' in JSON at position 1 (line 1 column 2)"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at subscriber.subscribe (src/common/base-server.ts:306:25)
      at Object.<anonymous> (tests/apps/command-processor-error-policy.spec.ts:62:5)

PASS tests/services/command-processor/parsing.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:14.496Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:24:34)

    console.warn
      {"ts":"2025-12-19T19:57:14.499Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:33:34)

    console.log
      {"ts":"2025-12-19T19:57:14.499Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":2,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/llm-bot-service.spec.ts
PASS tests/base-server-routing.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:14.564Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.566Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.566Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.569Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.569Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.569Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.570Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.570Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.step2.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.571Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.571Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.571Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.571Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"internal.egress.v1","correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.572Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.572Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.572Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.572Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.573Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.573Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.573Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.574Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.576Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.576Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.576Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.577Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":0,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.577Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.577Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.577Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.612Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":1,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/services/command-processor/command-repo.spec.ts
PASS tests/services/message-bus/nats-flush.spec.ts
PASS tests/services/command-processor/policy-rate-limit.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:14.866Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"RATE_LIMIT","rate":{"max":2,"perMs":60000},"windowKey":"20***0000","count":2}

      at Logger.info (src/common/logging.ts:142:13)

PASS infrastructure/cdktf/network/config.spec.ts
PASS tests/prompt-assembly/adapters.spec.ts
PASS tests/services/message-bus/pubsub-batching.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:15.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.136Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"internal.test.v1","batching":{"maxMessages":100,"maxMilliseconds":1500},"ensureMode":"on-publish-fail","publishTimeoutMs":0}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/prompt-assembly/truncation.spec.ts
PASS tests/prompt-assembly/assemble.spec.ts
PASS tests/services/message-bus/subscriber-dedupe.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:15.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.575Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.test.v1","subscription":"internal.test.v1.q","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.575Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.test.v1.q"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:15.575Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"message_consumer.dedupe.drop","driver":"pubsub","subscription":"internal.test.v1.q","idempotencyKey":"***","ttlMs":60000}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at SubscriptionMock.onMessage (src/services/message-bus/pubsub-driver.ts:338:22)
      at Object.<anonymous> (tests/services/message-bus/subscriber-dedupe.spec.ts:54:22)


ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/apps/command-processor-error-policy.spec.ts.

      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
PASS src/services/llm-bot/processor.error.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:15.599Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.599Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.599Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.616Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.216Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-error","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.217Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-error"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:17.217Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-error","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

    console.error
      {"ts":"2025-12-19T19:57:17.219Z","service":"test-llm-bot","level":"error","severity":"ERROR","msg":"openai.error","correlationId":"c-error","model":"gpt-5-mini","durationMs":0,"message":"boom","name":"Error"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:639:28)

    console.error
      {"ts":"2025-12-19T19:57:17.221Z","service":"test-llm-bot","level":"error","severity":"ERROR","msg":"llm_bot.error","message":"boom","correlationId":"c-error","err":{"pregelTaskId":"21c0e6ab-a267-564b-9bbf-96dd6b45cd06"}}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at processEvent (src/services/llm-bot/processor.ts:693:12)
      at Object.<anonymous> (src/services/llm-bot/processor.error.spec.ts:25:20)

PASS tests/prompt-assembly/redaction.spec.ts
PASS src/services/llm-bot/processor.memory.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:15.238Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.253Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.254Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:15.266Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.191Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-mem","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.192Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-mem"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:17.193Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-mem","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

    console.log
      {"ts":"2025-12-19T19:57:17.200Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.201Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.201Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.254Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-mem","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.255Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-mem"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.257Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.258Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.258Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.325Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-mem","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.325Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-mem"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/prompt-assembly/adapters/google.spec.ts
PASS tests/common/firestore-manager.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:17.423Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.424Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.424Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/prompt-assembly/conversation-state.spec.ts
PASS tests/services/command-processor/template-render.spec.ts
PASS tests/prompt-assembly/adapters/openai.spec.ts
PASS tests/common/retry.spec.ts
PASS tests/services/message-bus/nats-logging.spec.ts
PASS tests/services/llm-bot/personality-with-memory.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:16.093Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/common/events/attributes.spec.ts
PASS tests/services/command-processor/routing-advance.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:17.668Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.669Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.669Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.669Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.670Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.705Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.706Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.736Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.published","subject":"dev.internal.egress.v1","stepIndex":1,"attempt":0,"correlationId":"c-adv-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.739Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.739Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.739Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.739Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.740Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.740Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.740Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.766Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"dev.internal.egress.v1.dev1","correlationId":"c-adv-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.767Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.768Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/services/egress/selection.test.ts
PASS tests/services/message-bus/pubsub-attributes.spec.ts
PASS src/common/base-server.debug-config.test.ts (6.626 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:17.818Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.844Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.846Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/common/base-server.test.ts (6.664 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:17.909Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.936Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.937Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.967Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.968Z","service":"custom","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.968Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/integration/command-processor-smoke.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:18.013Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/integration/command-processor-smoke.spec.ts:31:39)

    console.log
      {"ts":"2025-12-19T19:57:18.014Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"hello","args":1,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.016Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"hello","id":"cmd-hello","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.016Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"hello","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.017Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"hello","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/services/message-bus/nats-attributes.spec.ts
PASS tests/services/command-processor/personality-annotation.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:18.129Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:37:35)

    console.log
      {"ts":"2025-12-19T19:57:18.130Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"greet","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.130Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"greet","id":"cmd-p1","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.131Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"greet","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.131Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"greet","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.131Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.personality.added","id":"cmd-p1","command":"greet","personality":"snarky"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.132Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:64:35)

    console.log
      {"ts":"2025-12-19T19:57:18.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"note","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"note","id":"cmd-p2","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.effect.added","effect":"annotation","name":"note","kind":"prompt"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.personality.added","id":"cmd-p2","command":"note","personality":"friendly"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.147Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:83:35)

    console.log
      {"ts":"2025-12-19T19:57:18.147Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"noop","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.147Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"noop","id":"cmd-p3","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.148Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.148Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.150Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:102:35)

    console.log
      {"ts":"2025-12-19T19:57:18.150Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"noop","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.151Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"noop","id":"cmd-p4","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.151Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.151Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.151Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.personality.invalid","id":"cmd-p4","name":"noop","value":"   "}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at maybeAppendPersonality (src/services/command-processor/processor.ts:237:16)
      at processEvent (src/services/command-processor/processor.ts:360:3)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:102:17)

    console.warn
      {"ts":"2025-12-19T19:57:18.151Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:109:36)

    console.log
      {"ts":"2025-12-19T19:57:18.152Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"noop","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.152Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"noop","id":"cmd-p5","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.152Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.152Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"noop","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.153Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.personality.invalid","id":"cmd-p5","name":"noop","valueType":"number"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at maybeAppendPersonality (src/services/command-processor/processor.ts:232:16)
      at processEvent (src/services/command-processor/processor.ts:360:3)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation.spec.ts:109:18)

PASS tests/services/message-bus/pubsub-logging.spec.ts
PASS tests/prompt-assembly/openai-adapter.spec.ts
PASS tests/prompt-assembly/adapters/edge-cases.spec.ts
PASS infrastructure/scripts/extract-config.test.ts
PASS tests/common/base-server-resources.spec.ts
PASS tests/services/command-processor/candidate-create.spec.ts
PASS src/services/oauth/routes.test.ts (7.485 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.374Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"mockprov","identity":"bot","mode":"json"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.429Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"mockprov","identity":"bot","mode":"redirect"}

      at Logger.info (src/common/logging.ts:142:13)

    console.error
      {"ts":"2025-12-19T19:57:18.457Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"oauth.routes.start.error","error":"unknown_provider:unknown"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at src/services/oauth/routes.ts:43:14
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

    console.log
      {"ts":"2025-12-19T19:57:18.476Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"mockprov","identity":"bot","stored":false,"tokenType":"***"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.481Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"mockprov","identity":"bot","status":"absent"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.486Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"mockprov","identity":"bot","stored":true,"tokenType":"***"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.490Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"mockprov","identity":"bot","status":"present"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/apps/__tests__/command-processor-service.test.ts (7.842 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:14.035Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.048Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.048Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.049Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.051Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.206Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:14.207Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:14.350Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at exec (src/apps/command-processor-service.ts:66:28)
      at src/apps/command-processor-service.ts:71:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:69:30
      at src/common/base-server.ts:298:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:295:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:11)

    console.error
      {"ts":"2025-12-19T19:57:17.313Z","service":"command-processor","level":"error","severity":"ERROR","msg":"regex_cache.snapshot.error","error":"Error 7: Missing or insufficient permissions."}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at QueryWatch.onError (src/services/command-processor/regex-cache.ts:150:14)
      at QueryWatch.closeStream (node_modules/@google-cloud/firestore/build/src/watch.js:227:18)
      at QueryWatch.onData (node_modules/@google-cloud/firestore/build/src/watch.js:376:22)
      at PassThrough.<anonymous> (node_modules/@google-cloud/firestore/build/src/watch.js:322:26)
      at StreamProxy.ondata (node_modules/readable-stream/lib/_stream_readable.js:629:20)
      at addChunk (node_modules/readable-stream/lib/_stream_readable.js:279:12)
      at readableAddChunk (node_modules/readable-stream/lib/_stream_readable.js:262:11)
      at StreamProxy.Object.<anonymous>.Readable.push (node_modules/readable-stream/lib/_stream_readable.js:228:10)
      at StreamProxy.Object.<anonymous>.Duplexify._forward (node_modules/duplexify/index.js:172:26)
      at ClientDuplexStreamImpl.onreadable (node_modules/duplexify/index.js:136:10)

    console.error
      {"ts":"2025-12-19T19:57:17.361Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.findFirstByCommandTerm.error","term":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at findFirstByCommandTerm (src/services/command-processor/command-repo.ts:143:12)
      at processEvent (src/services/command-processor/processor.ts:175:9)
      at exec (src/apps/command-processor-service.ts:66:22)
      at src/apps/command-processor-service.ts:71:28
      at src/apps/command-processor-service.ts:69:17
      at src/common/base-server.ts:298:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:295:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)

    console.error
      {"ts":"2025-12-19T19:57:17.362Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:100:20
      at src/common/base-server.ts:298:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:295:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.364Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:17.365Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:17.365Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at exec (src/apps/command-processor-service.ts:66:28)
      at src/apps/command-processor-service.ts:71:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:69:30
      at src/common/base-server.ts:298:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:295:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:11)

    console.error
      {"ts":"2025-12-19T19:57:18.681Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.findFirstByCommandTerm.error","term":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at findFirstByCommandTerm (src/services/command-processor/command-repo.ts:143:12)
      at processEvent (src/services/command-processor/processor.ts:175:9)
      at exec (src/apps/command-processor-service.ts:66:22)
      at src/apps/command-processor-service.ts:71:28
      at src/apps/command-processor-service.ts:69:17
      at src/common/base-server.ts:298:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:295:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)

    console.error
      {"ts":"2025-12-19T19:57:18.682Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:100:20
      at src/common/base-server.ts:298:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:295:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)

PASS tests/services/command-processor/processor.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:18.726Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:30:35)

    console.log
      {"ts":"2025-12-19T19:57:18.727Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.727Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"ping","id":"cmd1","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.727Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"ping","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.728Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"ping","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.728Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:56:35)

    console.log
      {"ts":"2025-12-19T19:57:18.728Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"note","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.728Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"note","id":"cmdA","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.728Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.effect.added","effect":"annotation","name":"note","kind":"prompt"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.729Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:79:35)

    console.log
      {"ts":"2025-12-19T19:57:18.729Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"cool","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.729Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"cool","id":"cmd3","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.729Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:99:35)

    console.log
      {"ts":"2025-12-19T19:57:18.730Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"missing","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.730Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:118:35)

    console.log
      {"ts":"2025-12-19T19:57:18.730Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"rate","args":0,"sigil":"!"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.730Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"rate","id":"cmd2","kind":"command"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:18.730Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:147:35)

PASS tests/services/command-processor/personality-annotation-regex.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:18.944Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/personality-annotation-regex.spec.ts:42:35)

    console.log
      {"ts":"2025-12-19T19:57:18.944Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"hello-cmd","id":"regex-1","kind":"regex"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.944Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"hello-cmd","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.945Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"hello-cmd","templateId":"t1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.945Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.personality.added","id":"regex-1","command":"hello-cmd","personality":"friendly"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/base-server-onmessage.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.993Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.994Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.994Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.995Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.test.json","queue":"test"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.995Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.test.json","queue":"test"}

      at Logger.info (src/common/logging.ts:142:13)


ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/services/command-processor/routing-advance.spec.ts.

      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
PASS tests/common/base-server-get-resource.spec.ts
PASS tests/services/command-processor/policy-global-cooldown.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.140Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"GLOBAL_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:01.000Z","remainingMs":6000}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/router-annotations-e2e.spec.ts
PASS tests/base-server-step-update.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.294Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.304Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.304Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.309Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.310Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.310Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.311Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.311Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.311Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.312Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.312Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.312Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.313Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.313Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.313Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/services/command-processor/logging.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:19.542Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/logging.spec.ts:31:35)

PASS tools/brat/src/orchestration/exec.spec.ts
PASS tests/common/publisher-manager.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.677Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.679Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:19.679Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"publisher.manager.flush.error","error":"boom"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at Object.flushAll (src/common/resources/publisher-manager.ts:33:15)
      at Object.<anonymous> (tests/common/publisher-manager.spec.ts:40:5)

    console.log
      {"ts":"2025-12-19T19:57:19.680Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tests/services/message-bus/normalize-attributes.spec.ts
PASS src/services/router/__tests__/rule-loader.hardening.test.ts
  ● Console

    console.error
      {"ts":"2025-12-19T19:57:19.672Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.warm_load_error","error":"emulator not available"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:161:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:12:5)

    console.error
      {"ts":"2025-12-19T19:57:19.701Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.subscribe_error","error":"listen failed"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:175:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:26:5)

PASS src/services/llm-bot/processor.openai.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.590Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.591Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.591Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.594Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.816Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-openai","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.816Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-openai"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:19.817Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-openai","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/services/llm-bot/processor.personality.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.402Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.402Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.403Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.406Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.810Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-pers","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.810Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":1,"names":[],"versions":[],"metrics":{"resolved":1,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"PERS","constraintsCount":0,"correlationId":"c-pers"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:19.811Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-pers","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS tests/services/command-processor/policy-user-cooldown.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.894Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"USER_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:02.000Z","remainingMs":7000,"userId":"u-1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/__tests__/processor.unwrap-quotes.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.900Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.900Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.900Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:19.907Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-unwrap","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS tools/brat/src/providers/cdktf-synth.spec.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS tests/services/command-processor/template-selection.spec.ts
PASS src/services/ingress/discord/discord-ingress-client.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.044Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.start","guildId":"g1","channelsCount":1}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.046Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.message.published","correlationId":"0ef41e04-f499-4fcf-9e31-25d7cea39c61","channelId":"c1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.047Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.start","guildId":"g1","channelsCount":1}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.047Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.start","guildId":"g1","channelsCount":1}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.047Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.start","guildId":"g1","channelsCount":1}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/message-bus/__tests__/pubsub-publisher-logging.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.067Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.067Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.068Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.068Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/apps/command-processor-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.182Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.183Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.183Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.183Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.183Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.regex_cache.skipped_in_tests"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.184Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.185Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.185Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/apps/llm-bot-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.198Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.209Z","service":"llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.209Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.211Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.llmbot.v1","queue":"llm-bot"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.211Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.llmbot.v1","queue":"llm-bot"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/__tests__/personality-metrics.spec.ts
PASS src/services/llm-bot/reducer.spec.ts
PASS src/services/llm-bot/__tests__/processor.personality-name.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.311Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.312Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.312Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.315Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-pers-name","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.315Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":1,"names":["p1"],"versions":[7],"metrics":{"resolved":1,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":1,"clamped":0},"identityPreview":"DBTEXT","constraintsCount":0,"correlationId":"c-pers-name"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:20.315Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-pers-name","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/apps/persistence-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.327Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.328Z","service":"persistence","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.328Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.ingress.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.ingress.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.ingress.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.persistence.finalize.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.persistence.finalize.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.329Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.persistence.finalize.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/common/__tests__/discord-secret.test.ts
FAIL src/common/firebase.test.ts
  ● common/firebase getFirestore() › initializes admin once and binds to default database id when not configured

    TypeError: db.settings is not a function

      49 |     // Bind Firestore to the named database (multi-database support)
      50 |     const db = gfs(databaseId);
    > 51 |     db.settings({ ignoreUndefinedProperties: true });
         |        ^
      52 |     cachedDb = db;
      53 |     initialized = true;
      54 |     logger.debug('firestore.initialized');

      at getFirestore (src/common/firebase.ts:51:8)
      at Object.<anonymous> (src/common/firebase.test.ts:31:17)

  ● common/firebase getFirestore() › uses configured databaseId when provided via configureFirestore()

    TypeError: db.settings is not a function

      49 |     // Bind Firestore to the named database (multi-database support)
      50 |     const db = gfs(databaseId);
    > 51 |     db.settings({ ignoreUndefinedProperties: true });
         |        ^
      52 |     cachedDb = db;
      53 |     initialized = true;
      54 |     logger.debug('firestore.initialized');

      at Object.getFirestore (src/common/firebase.ts:51:8)
      at Object.<anonymous> (src/common/firebase.test.ts:46:9)

PASS src/apps/ingress-egress-service.finalize.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.173Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.184Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.185Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.186Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.186Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.188Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.189Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.error
      {"ts":"2025-12-19T19:57:20.607Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"connector.start_error","name":"twitch","error":"twitch_auth_missing"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:39:34)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:104:7)

    console.log
      {"ts":"2025-12-19T19:57:20.608Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.609Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-ivmxlt5v","queue":"ingress-egress.proc-ivmxlt5v"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.609Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-ivmxlt5v"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.609Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.610Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.612Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"fx-1","candidateId":"c1","priority":1,"createdAt":"2025-12-19T19:57:20.611Z"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.615Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"fx-1","source":"","isDiscord":false}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.616Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"fx-1","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/apps/oauth-service.oauth-routes.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.629Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.630Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.630Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.631Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/apps/event-router-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.671Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.672Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.672Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.672Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.673Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.673Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.673Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.673Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.673Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.679Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.680Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.687Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.688Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.690Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.691Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.692Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.692Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.693Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/processor.test.ts (9.695 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.611Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.628Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.628Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.644Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.691Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-1","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.692Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.700Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.no_prompt_annotations","correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.702Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.703Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.704Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.775Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-1","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.775Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:20.776Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-1","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/apps/ingress-egress-service.krevision.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.644Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.646Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.646Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.646Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.745Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.899Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.900Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.900Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.900Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/__tests__/processor.personality-mixed.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.935Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.936Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.936Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.939Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-pers-mixed","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.939Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":2,"names":["p2"],"versions":[9],"metrics":{"resolved":2,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":1,"clamped":0},"identityPreview":"INLINE\n\nDBTEXT2","constraintsCount":0,"correlationId":"c-pers-mixed"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:20.939Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-pers-mixed","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/apps/oauth-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:20.957Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.957Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.957Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.958Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/twitch-oauth.test.ts
PASS tools/brat/src/cli/trigger.spec.ts
PASS src/services/llm-bot/processor.instance-memory.spec.ts (10.07 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.378Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.400Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.400Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.493Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.511Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-inst","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.512Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-inst"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:20.512Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-inst","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

    console.log
      {"ts":"2025-12-19T19:57:20.664Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-inst","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.664Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-inst"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.843Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.849Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.850Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.024Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-inst","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.024Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-inst"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.147Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-inst","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.147Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-inst"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.198Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.200Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:21.200Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"topic.test","error":"pubsub.topic is not a function"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:60:29)

    console.warn
      {"ts":"2025-12-19T19:57:21.200Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"topic.test","subscription":"topic.test.sub","error":"pubsub.topic is not a function"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:60:19)

    console.log
      {"ts":"2025-12-19T19:57:21.200Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.219Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.219Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:21.219Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"topic.test","error":"pubsub.topic is not a function"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:86:29)

    console.warn
      {"ts":"2025-12-19T19:57:21.219Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"topic.test","subscription":"topic.test.sub","error":"pubsub.topic is not a function"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:86:19)

    console.log
      {"ts":"2025-12-19T19:57:21.219Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/oauth/oauth-flow.integration.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.236Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"twitch","identity":"bot","mode":"redirect"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.239Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"twitch","identity":"bot","mode":"json"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.242Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"twitch","identity":"bot","stored":true,"tokenType":"***","providerUserId":"u-123"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.243Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"twitch","identity":"bot","status":"present"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/oauth/providers/discord-adapter.test.ts
PASS src/apps/__tests__/event-router-debug.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.287Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.288Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.288Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.288Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.289Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.289Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.289Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.296Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.297Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.300Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.300Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.301Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.301Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.301Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.301Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.301Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.302Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.302Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.320Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/processor.personality-disabled.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.954Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.954Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.955Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.969Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.324Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-pers-disabled","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:21.325Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-pers-disabled","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/types/events.types.test.ts
PASS tools/brat/src/cli/__tests__/deploy-substitutions.scaling.test.ts
PASS src/services/routing/routing.slip.test.ts
PASS src/services/llm-bot/processor.empty-response.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:19.107Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.108Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.108Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.118Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.326Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-empty","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.328Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-empty"}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:21.329Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-empty","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

    console.log
      {"ts":"2025-12-19T19:57:21.340Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.398Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-empty","mode":"append","hasDescription":false,"preview":""}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.398Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.mapped","count":0,"names":[],"versions":[],"metrics":{"resolved":0,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"identityPreview":"","constraintsCount":0,"correlationId":"c-empty"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.400Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/ingress/twitch/twitch-irc-client.spec.ts
PASS src/common/base-server.logger.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.452Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.453Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.453Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.454Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.454Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.454Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/common/__tests__/base-server-yaml.test.ts
PASS src/apps/__tests__/ingress-egress-routing.test.ts (10.361 s)
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:18.752Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.834Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.836Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.836Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.836Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.842Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:18.843Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.390Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.403Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"internal.ingress.v1","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.403Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.409Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.410Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-dz2fvuo2","queue":"ingress-egress.proc-dz2fvuo2"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.410Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.410Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-dz2fvuo2","queue":"ingress-egress.proc-dz2fvuo2"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.410Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-dz2fvuo2","subscription":"internal.egress.v1.proc-dz2fvuo2.ingress-egress.proc-dz2fvuo2","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.907Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-1","candidateId":"cand-1","priority":1,"createdAt":"2025-12-19T19:57:19.905Z"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.913Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-1","source":"ingress.discord","isDiscord":true}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.917Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-1","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.933Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.934Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.950Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.956Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-01dcbdxc","queue":"ingress-egress.proc-01dcbdxc"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.957Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.957Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-01dcbdxc","queue":"ingress-egress.proc-01dcbdxc"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:19.958Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-01dcbdxc","subscription":"internal.egress.v1.proc-01dcbdxc.ingress-egress.proc-01dcbdxc","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.436Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-3","candidateId":"cand-3","priority":1,"createdAt":"2025-12-19T19:57:20.436Z"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.437Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-3","source":"command-processor","isDiscord":true}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.437Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-3","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.439Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.439Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.440Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.440Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.440Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.440Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.440Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.441Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.441Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-ksch9mwd","queue":"ingress-egress.proc-ksch9mwd"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.441Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.441Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-ksch9mwd","queue":"ingress-egress.proc-ksch9mwd"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.441Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-ksch9mwd","subscription":"internal.egress.v1.proc-ksch9mwd.ingress-egress.proc-ksch9mwd","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.942Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-v1","source":"ingress.discord","isDiscord":true}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.943Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-v1","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.944Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.944Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.945Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.945Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.946Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.946Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-3myixdvx","queue":"ingress-egress.proc-3myixdvx"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-3myixdvx","queue":"ingress-egress.proc-3myixdvx"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:20.947Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-3myixdvx","subscription":"internal.egress.v1.proc-3myixdvx.ingress-egress.proc-3myixdvx","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.453Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-2","candidateId":"cand-2","priority":1,"createdAt":"2025-12-19T19:57:21.452Z"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.453Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-2","source":"ingress.twitch","isDiscord":false}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.454Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-2","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/persistence/store.spec.ts
PASS src/services/llm-bot/__tests__/personality-resolver-sorting.spec.ts
PASS src/services/ingress/twitch/credentials-provider.spec.ts
PASS src/apps/__tests__/event-router-ingress.integration.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.575Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.576Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.576Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.577Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.579Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/ingress/twitch/credentials-provider.config.spec.ts
PASS src/apps/ingress-egress-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.613Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.616Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.616Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.617Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.618Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.619Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.620Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.620Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.620Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/oauth/provider-registry.test.ts
PASS src/apps/auth-service.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.667Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.668Z","service":"auth","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.668Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.669Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/persistence/integration.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.638Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.645Z","service":"persistence","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.645Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.646Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.ingress.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.646Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.persistence.finalize.v1","queue":"persistence"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.647Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.ingress.v1","type":"chat.message.v1","correlationId":"it-1"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.647Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.upsert.ok","correlationId":"it-1","status":"INGESTED"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.663Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-2"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.678Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-2","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.679Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-3"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.679Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-3","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.680Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-ttl-seconds"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.680Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-ttl-seconds","status":"SENT"}

      at Logger.info (src/common/logging.ts:142:13)

PASS tools/brat/src/providers/gcp/cloudbuild-triggers.spec.ts
PASS src/services/llm-bot/__tests__/user-context.append.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.724Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.725Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.726Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.729Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.user_ctx.compose.end","correlationId":"c-userctx-append","mode":"append","hasDescription":true,"preview":"Username: Alice\nRoles: VIP\nThey are a VIP.\nDescription: Loves JRPGs."}

      at Logger.info (src/common/logging.ts:142:13)

    console.warn
      {"ts":"2025-12-19T19:57:21.729Z","service":"test-llm-bot","level":"warn","severity":"WARNING","msg":"llm_bot.deprecation.input_context_history","correlationId":"c-userctx-append","note":"Conversation history is no longer injected into Input.context. It is now rendered under [Conversation State / History]."}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:503:25)
      at RunnableCallable.invoke (node_modules/@langchain/langgraph/src/utils.ts:124:18)
      at RunnableSequence.invoke (node_modules/@langchain/core/dist/runnables/base.cjs:1321:33)
      at _runWithRetry (node_modules/@langchain/langgraph/src/pregel/retry.ts:105:16)
      at PregelRunner._executeTasksWithRetry (node_modules/@langchain/langgraph/src/pregel/runner.ts:351:21)
      at PregelRunner.tick (node_modules/@langchain/langgraph/src/pregel/runner.ts:135:31)
      at CompiledStateGraph._runLoop (node_modules/@langchain/langgraph/dist/pregel/index.cjs:1482:17)
      at createAndRunLoop (node_modules/@langchain/langgraph/src/pregel/index.ts:1945:8)

PASS src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:21.763Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.764Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.764Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.subscription.created","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.764Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.791Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.792Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:21.792Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/llm-bot/__tests__/personality-resolver.spec.ts
PASS src/services/router/__tests__/jsonlogic-re-test.spec.ts
PASS src/services/ingress/twitch/publisher.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:21.841Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":1,"code":14}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)

    console.warn
      {"ts":"2025-12-19T19:57:21.846Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":2,"code":14}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)

    console.warn
      {"ts":"2025-12-19T19:57:21.848Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.no_retry_on_timeout","subject":"dev.internal.ingress.v1","attempt":1,"code":4,"reason":"publish_timeout"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:67:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:102:5)

PASS src/services/oauth/providers/twitch-adapter.test.ts
PASS src/common/config.test.ts
PASS tools/brat/src/config/schema.routing.test.ts
PASS src/services/router/__tests__/rule-loader.test.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:21.921Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"d"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:188:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:158:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)

    console.warn
      {"ts":"2025-12-19T19:57:21.922Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"e"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:188:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:158:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)

PASS tools/brat/src/config/__tests__/interpolation.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["ENV","NOPE"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":["UNKNOWN_VAR"],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS tools/brat/src/providers/cdktf-synth.loadbalancer.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS src/services/llm-bot/instance-memory.spec.ts
PASS src/services/router/__tests__/rule-loader-annotations.spec.ts
  ● Console

    console.warn
      {"ts":"2025-12-19T19:57:22.027Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.annotation_invalid","ruleId":"r-1"}

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at Logger.warn (src/common/logging.ts:137:13)
      at sanitizeAnnotations (src/services/router/rule-loader.ts:68:14)
      at validateRule (src/services/router/rule-loader.ts:97:23)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:185:20)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader-annotations.spec.ts:24:21)

PASS src/services/ingress/discord/discord-ingress-client.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:32.010Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.token.rotated"}

      at Logger.info (src/common/logging.ts:142:13)


ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From src/apps/__tests__/ingress-egress-routing.test.ts.

      at new PublisherClient (node_modules/@google-cloud/pubsub/src/v1/publisher_client.ts:161:21)
      at PubSub.getClientAsync_ (node_modules/@google-cloud/pubsub/src/pubsub.ts:1316:19)

  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.077Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"internal.egress.v1.proc-3myixdvx","error":"this._gaxModule.GrpcClient is not a constructor"}".

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.083Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"internal.egress.v1.proc-3myixdvx","subscription":"internal.egress.v1.proc-3myixdvx.ingress-egress.proc-3myixdvx","error":"this._gaxModule.GrpcClient is not a constructor"}".

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.085Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.egress.v1.proc-3myixdvx.ingress-egress.proc-3myixdvx"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:290:12)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.086Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.egress.v1.proc-3myixdvx","queue":"ingress-egress.proc-3myixdvx"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onMessage (src/common/base-server.ts:313:19)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.087Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-3myixdvx"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:229:16)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.087Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:251:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:236:10)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.088Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:251:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:242:10)

PASS tools/brat/src/lb/urlmap/__tests__/renderer.routing.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.example.com default_bucket=site-assets selected_default_backend=be-assets-proxy

      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)

PASS src/common/__tests__/logging-trace-correlation.spec.ts
PASS src/services/ingress/discord/envelope-builder.spec.ts

  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.110Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"pubsub.subscription.error","subscription":"internal.egress.v1.proc-3myixdvx.ingress-egress.proc-3myixdvx","details":"TypeError: this._gaxModule.GrpcClient is not a constructor"}".

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at Subscription.onError (src/services/message-bus/pubsub-driver.ts:372:14)
      at Subscriber.<anonymous> (node_modules/@google-cloud/pubsub/src/subscription.ts:338:32)
      at MessageStream.<anonymous> (node_modules/@google-cloud/pubsub/src/subscriber.ts:1181:32)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.122Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"internal.egress.v1.proc-ksch9mwd","error":"this._gaxModule.GrpcClient is not a constructor"}".

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)

PASS src/services/oauth/auth-token-store.test.ts
PASS tools/brat/src/config/__tests__/allow-unauth.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS src/services/message-bus/nats-driver.test.ts

  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.154Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"internal.egress.v1.proc-ksch9mwd","subscription":"internal.egress.v1.proc-ksch9mwd.ingress-egress.proc-ksch9mwd","error":"this._gaxModule.GrpcClient is not a constructor"}".

      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {

      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)

PASS src/common/__tests__/discord-config.test.ts

  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.179Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.egress.v1.proc-ksch9mwd.ingress-egress.proc-ksch9mwd"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:290:12)
      at IngressEgressServer.onMessage (src/common/base-server.ts:289:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.183Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.egress.v1.proc-ksch9mwd","queue":"ingress-egress.proc-ksch9mwd"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onMessage (src/common/base-server.ts:313:19)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:117:9)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.185Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-ksch9mwd"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:229:16)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.189Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:251:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:236:10)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.190Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}".

      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:251:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:242:10)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-19T19:57:22.191Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"pubsub.subscription.error","subscription":"internal.egress.v1.proc-ksch9mwd.ingress-egress.proc-ksch9mwd","details":"TypeError: this._gaxModule.GrpcClient is not a constructor"}".

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at Subscription.onError (src/services/message-bus/pubsub-driver.ts:372:14)
      at Subscriber.<anonymous> (node_modules/@google-cloud/pubsub/src/subscription.ts:338:32)
      at MessageStream.<anonymous> (node_modules/@google-cloud/pubsub/src/subscriber.ts:1181:32)

PASS src/services/router/__tests__/jsonlogic-evaluator.test.ts
PASS tools/brat/src/providers/cdktf-synth.loadbalancer.routing.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS src/services/twitch-token-manager.test.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:22.199Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch_token_manager.refreshed"}

      at Logger.info (src/common/logging.ts:142:13)

    console.error
      {"ts":"2025-12-19T19:57:22.201Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twitch_token_manager.refresh_failed","status":400,"body":"bad"}

      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {

      at Logger.error (src/common/logging.ts:132:13)
      at doRefresh (src/services/twitch-token-manager.ts:84:18)
      at TwitchTokenManager.getValidToken (src/services/twitch-token-manager.ts:42:12)
      at TwitchTokenManager.getValidAccessToken (src/services/twitch-token-manager.ts:22:19)
      at Object.<anonymous> (src/services/twitch-token-manager.test.ts:64:17)

PASS infrastructure/scripts/bootstrap-service.test.js
PASS src/services/ingress/discord/discord-integration.spec.ts
  ● Console

    console.log
      {"ts":"2025-12-19T19:57:22.215Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.start","guildId":"g1","channelsCount":1}

      at Logger.info (src/common/logging.ts:142:13)

    console.log
      {"ts":"2025-12-19T19:57:22.217Z","service":"bitbrat","level":"info","severity":"INFO","msg":"ingress-egress.discord.message.published","correlationId":"66c05d92-e897-4efb-ac67-e3f385fef53b","channelId":"c1"}

      at Logger.info (src/common/logging.ts:142:13)

PASS src/services/persistence/model.spec.ts
PASS src/services/routing/__tests__/router-engine-ops-integration.spec.ts
PASS src/services/message-bus/__tests__/subscriber-options.test.ts
PASS tools/brat/src/lb/urlmap/__tests__/renderer.test.ts
PASS tools/brat/src/providers/gcp/apis.spec.ts
PASS tools/brat/src/lb/importer/__tests__/importer.guard.test.ts
PASS src/common/retry.test.ts
PASS tools/brat/src/config/schema.network.spec.ts
PASS tools/brat/src/config/loader.spec.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS src/services/message-bus/__tests__/factory-selection.test.ts
PASS src/services/routing/__tests__/router-engine.test.ts
PASS src/services/routing/routing.dlq.test.ts
PASS tools/brat/src/lb/importer/__tests__/importer.test.ts
PASS tools/brat/src/providers/cdktf-synth.buckets.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS src/services/ingress/discord/discord-observability.spec.ts
PASS src/services/llm-bot/__tests__/prompt-composer.spec.ts
PASS tools/brat/src/config/__tests__/resolve-services.scaling.test.ts
PASS src/services/routing/__tests__/router-engine-annotations.spec.ts
PASS src/services/ingress/twitch/envelope-builder.spec.ts
PASS src/services/router/__tests__/jsonlogic-extra-ops.spec.ts
PASS tools/brat/src/config/schema.spec.ts
PASS src/services/router/__tests__/jsonlogic-ci-eq.spec.ts
PASS tools/brat/src/lb/urlmap/__tests__/load-from-arch.test.ts
PASS tools/brat/src/lb/urlmap/__tests__/from-repo-arch.test.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.bitbrat.ai default_bucket=default-content-bucket selected_default_backend=be-assets-proxy

      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)

PASS tools/brat/src/providers/gcp/secrets.spec.ts
PASS tools/brat/src/providers/gcp/cloudbuild.spec.ts
PASS tools/brat/src/providers/cdktf-synth.connectors.spec.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS tools/brat/src/orchestration/errors.spec.ts
PASS src/services/router/__tests__/jsonlogic-slip-complete.spec.ts
PASS tools/brat/src/providers/cdktf-synth.network.spec.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS tools/brat/src/providers/gcp/preflight.spec.ts
  ● Console

    console.warn
      [preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.

      22 |     }
      23 |     // Local override: permit skipping checks for development
    > 24 |     console.warn('[preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.');
         |             ^
      25 |     return;
      26 |   }
      27 |

      at assertVpcPreconditions (tools/brat/src/providers/gcp/preflight.ts:24:13)
      at Object.<anonymous> (tools/brat/src/providers/gcp/preflight.spec.ts:32:40)

PASS tools/brat/src/providers/gcp/cloudrun.spec.ts
PASS tools/brat/src/providers/gcp/lb-preflight.spec.ts
PASS tools/brat/src/providers/cdktf-synth.lb.spec.ts
  ● Console

    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}

      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)

PASS tools/brat/src/config/schema.test.ts
PASS src/common/feature-flags.test.ts
PASS src/services/message-bus/message-bus.test.ts
PASS src/services/ingress/twitch/__tests__/twurple-integration.spec.ts
A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.

Summary of all failing tests
FAIL src/common/firebase.test.ts
  ● common/firebase getFirestore() › initializes admin once and binds to default database id when not configured

    TypeError: db.settings is not a function

      49 |     // Bind Firestore to the named database (multi-database support)
      50 |     const db = gfs(databaseId);
    > 51 |     db.settings({ ignoreUndefinedProperties: true });
         |        ^
      52 |     cachedDb = db;
      53 |     initialized = true;
      54 |     logger.debug('firestore.initialized');

      at getFirestore (src/common/firebase.ts:51:8)
      at Object.<anonymous> (src/common/firebase.test.ts:31:17)

  ● common/firebase getFirestore() › uses configured databaseId when provided via configureFirestore()

    TypeError: db.settings is not a function

      49 |     // Bind Firestore to the named database (multi-database support)
      50 |     const db = gfs(databaseId);
    > 51 |     db.settings({ ignoreUndefinedProperties: true });
         |        ^
      52 |     cachedDb = db;
      53 |     initialized = true;
      54 |     logger.debug('firestore.initialized');

      at Object.getFirestore (src/common/firebase.ts:51:8)
      at Object.<anonymous> (src/common/firebase.test.ts:46:9)


Test Suites: 1 failed, 2 skipped, 169 passed, 170 of 172 total
Tests:       2 failed, 10 skipped, 449 passed, 461 total
Snapshots:   2 passed, 2 total
Time:        12.814 s
Ran all test suites.
