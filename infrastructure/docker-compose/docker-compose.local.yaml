
services:
  nats:
    image: nats:2-alpine
    command: ["-js", "-sd", "/data", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/varz"]
      interval: 5s
      timeout: 3s
      retries: 10
    volumes:
      - nats-data:/data

  nats-box:
    image: natsio/nats-box:latest
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
    entrypoint: ["/bin/sh", "-c", "tail -f /dev/null"]

  firebase-emulator:
    build:
      context: .
      dockerfile: infrastructure/docker-compose/Dockerfile.emulator
    user: root
    working_dir: /data
    environment:
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-bitbrat-local}
      - GCLOUD_PROJECT=${FIREBASE_PROJECT_ID:-bitbrat-local}
      - GOOGLE_CLOUD_PROJECT=${FIREBASE_PROJECT_ID:-bitbrat-local}
      - GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/google-app-creds.json
      - ONLY_EMULATORS=firestore,pubsub,ui
    volumes:
      - .:/workspace:ro
      - firebase-data:/data
      - ${GOOGLE_APPLICATION_CREDENTIALS:?Set GOOGLE_APPLICATION_CREDENTIALS to a local JSON file}:/var/secrets/google-app-creds.json:ro
    ports:
      - "4000:4000"
      - "8080:8080"
      - "8085:8085"
      - "4400:4400"
      - "9150:9150"
    healthcheck:
      test: ["CMD", "bash", "-c", "curl -sf http://localhost:4000 && curl -sf http://localhost:8080"]
      interval: 5s
      timeout: 5s
      retries: 30
    stop_signal: SIGINT
    stop_grace_period: 1m

volumes:
  nats-data:
    driver: local
  firebase-data:
    driver: local
