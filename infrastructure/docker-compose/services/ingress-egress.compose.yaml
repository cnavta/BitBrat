services:
  ingress-egress:
    build:
      context: .
      dockerfile: Dockerfile.ingress-egress
    env_file:
      - .env.local
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/google-app-creds.json
      - TWITCH_BOT_USERNAME=${TWITCH_BOT_USERNAME}
      - TWITCH_CHANNELS=${TWITCH_CHANNELS}
      - DISCORD_ENABLED=${DISCORD_ENABLED}
      - TWILIO_ENABLED=${TWILIO_ENABLED}
      - K_REVISION=${K_REVISION}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_API_KEY=${TWILIO_API_KEY}
      - TWILIO_API_SECRET=${TWILIO_API_SECRET}
      - TWILIO_CHAT_SERVICE_SID=${TWILIO_CHAT_SERVICE_SID}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:?Set GOOGLE_APPLICATION_CREDENTIALS to a local JSON file}:/var/secrets/google-app-creds.json:ro
    ports:
      - "${INGRESS_EGRESS_HOST_PORT:-3001}:${SERVICE_PORT:-3000}"
    depends_on:
      - nats
      - firebase-emulator
      - obs-mcp
      - auth
      - scheduler
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      bitbrat-network:
        aliases:
          - ingress-egress.bitbrat.local
