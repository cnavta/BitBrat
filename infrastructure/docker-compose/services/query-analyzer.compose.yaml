services:
  query-analyzer:
    build:
      context: .
      dockerfile: Dockerfile.query-analyzer
    env_file:
      - .env.local
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/google-app-creds.json
      - LLM_PROVIDER=${QUERY_ANALYZER_LLM_PROVIDER:-${LLM_PROVIDER}}
      - LLM_MODEL=${QUERY_ANALYZER_LLM_MODEL:-${LLM_MODEL}}
      - LLM_BASE_URL=${QUERY_ANALYZER_LLM_BASE_URL:-${LLM_BASE_URL}}
      - LLM_API_KEY=${QUERY_ANALYZER_LLM_API_KEY:-${LLM_API_KEY}}
      - FF_LLM_PROMPT_LOGGING=${QUERY_ANALYZER_FF_LLM_PROMPT_LOGGING:-${FF_LLM_PROMPT_LOGGING}}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:?Set GOOGLE_APPLICATION_CREDENTIALS to a local JSON file}:/var/secrets/google-app-creds.json:ro
    ports:
      - "${QUERY_ANALYZER_HOST_PORT:-3001}:${SERVICE_PORT:-3000}"
    depends_on:
      - nats
      - firebase-emulator
      - ollama
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      bitbrat-network:
        aliases:
          - query-analyzer.bitbrat.local

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    volumes:
      - ollama_data:/root/.ollama
    networks:
      bitbrat-network:
        aliases:
          - ollama.bitbrat.local
    # healthcheck:
    #   test: ["CMD", "ollama", "list"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5

volumes:
  ollama_data:
    driver: local
