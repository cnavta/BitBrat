ðŸ”§ Installing dependencies...
npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm warn deprecated lodash.isequal@4.5.0: This package is deprecated. Use require('node:util').isDeepStrictEqual instead.
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated scmp@2.1.0: Just use Node.js's crypto.timingSafeEqual()
npm warn deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
npm warn deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
npm warn deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
npm warn deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
npm warn deprecated node-domexception@1.0.0: Use your platform's native DOMException instead
added 902 packages, and audited 903 packages in 8s
167 packages are looking for funding
  run `npm fund` for details
19 vulnerabilities (12 low, 2 moderate, 5 high)
To address issues that do not require attention, run:
  npm audit fix
To address all issues (including breaking changes), run:
  npm audit fix --force
Run `npm audit` for details.
ðŸ§± Building project...
> bitbrat-platform@1.0.0 build
> tsc -p tsconfig.json
ðŸ§ª Running MCP Server tests...
> bitbrat-platform@1.0.0 test
> jest tests/common/mcp-server.spec.ts
  console.log
    {"ts":"2026-01-15T15:49:53.357Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.376Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.378Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.387Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.388Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.398Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.402Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.406Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.407Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.407Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.408Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.409Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.410Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.412Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.412Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.414Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.415Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.415Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.416Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.416Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.417Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.417Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.418Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.419Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.420Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.warn
    {"ts":"2026-01-15T15:49:53.430Z","service":"test-mcp-server","level":"warn","severity":"WARNING","msg":"mcp_server.auth_failed","path":"/sse","ip":"::ffff:127.0.0.1"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at authMiddleware (src/common/mcp-server.ts:187:28)
      at src/common/mcp-server.ts:199:7
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)
  console.log
    {"ts":"2026-01-15T15:49:53.434Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.435Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.435Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.436Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.436Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.437Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.438Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.439Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.warn
    {"ts":"2026-01-15T15:49:53.440Z","service":"test-mcp-server","level":"warn","severity":"WARNING","msg":"mcp_server.auth_failed","path":"/sse","ip":"::ffff:127.0.0.1"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at authMiddleware (src/common/mcp-server.ts:187:28)
      at src/common/mcp-server.ts:199:7
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)
  console.log
    {"ts":"2026-01-15T15:49:53.442Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.443Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.444Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.445Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.446Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.447Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.448Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.448Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.450Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.450Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.451Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.451Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.451Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.452Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.452Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.453Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.454Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.454Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.456Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.457Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.458Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.458Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.459Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.460Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.460Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.462Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.463Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.464Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.464Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.465Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.466Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.467Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.467Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.468Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.468Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.469Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.469Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.470Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.470Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.472Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.490Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.491Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.tool_registered","name":"test_tool"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.492Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.493Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.493Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.494Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.495Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.495Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.497Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.499Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.500Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.resource_registered","name":"test_resource","uri":"file://test"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.501Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.501Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.502Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.502Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.502Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.503Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.504Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.505Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.505Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.prompt_registered","name":"test_prompt"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.506Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.506Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
  console.log
    {"ts":"2026-01-15T15:49:53.506Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
(node:64147) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGTERM listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64147) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:64147) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 beforeExit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:64147) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 exit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
 PASS  tests/common/mcp-server.spec.ts
  McpServer
    Endpoints Registration
      âœ“ should register /sse and /message endpoints (52 ms)
    Security
      âœ“ should allow access if MCP_AUTH_TOKEN is not set (8 ms)
      âœ“ should return 401 if MCP_AUTH_TOKEN is set and token is missing (18 ms)
      âœ“ should return 401 if MCP_AUTH_TOKEN is set and token is incorrect (9 ms)
      âœ“ should allow access if correct token is provided in header (7 ms)
      âœ“ should allow access if correct token is provided in query (7 ms)
    Registration Helpers
      âœ“ should use description and version from architecture.yaml (10 ms)
      âœ“ should register a tool correctly (24 ms)
      âœ“ should register a resource correctly (8 ms)
      âœ“ should register a prompt correctly (5 ms)
Test Suites: 1 passed, 1 total
Tests:       10 passed, 10 total
Snapshots:   0 total
Time:        2.58 s
Ran all test suites matching /tests\/common\/mcp-server.spec.ts/i.
ðŸ§ª Running all tests (silent)...
> bitbrat-platform@1.0.0 test
> jest --silent
(node:64253) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/persistence/store.spec.ts (6.98 s)
(node:64252) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/auth/__tests__/enrichment.spec.ts (7.415 s)
(node:64247) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64256) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tools/brat/src/config/schema.routing.test.ts (7.504 s)
(node:64255) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tools/brat/src/providers/cdktf-synth.loadbalancer.routing.test.ts (7.679 s)
(node:64246) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64254) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twitch/__tests__/eventsub-client.repro.spec.ts (7.819 s)
(node:64253) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGTERM listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:64253) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:64253) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 beforeExit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:64253) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 exit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
 PASS  tests/common/mcp-server.spec.ts
(node:64248) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64249) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64250) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:64251) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/apps/scheduler-service.spec.ts (10.389 s)
(node:64431) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/apps/__tests__/ingress-egress-webhooks.test.ts (10.687 s)
 PASS  tests/services/llm-bot/mcp/web-search.test.ts (10.851 s)
 PASS  src/services/llm-bot/processor.error.spec.ts
 PASS  src/services/llm-bot/processor.test.ts
 PASS  src/services/llm-bot/processor.personality.spec.ts
 PASS  src/apps/__tests__/ingress-egress-routing.test.ts (11.304 s)
 PASS  src/common/retry.test.ts
 PASS  src/apps/ingress-egress-service.krevision.test.ts
 PASS  src/services/llm-bot/processor.empty-response.spec.ts
 PASS  tools/brat/src/providers/cdktf-synth.loadbalancer.test.ts
 PASS  src/services/llm-bot/processor.memory.spec.ts
 PASS  tests/services/command-processor/routing-advance.spec.ts
 PASS  src/services/llm-bot/processor.instance-memory.spec.ts
 PASS  src/common/base-server.test.ts
 PASS  tools/brat/src/orchestration/exec.spec.ts
 PASS  src/apps/ingress-egress-service.test.ts
 PASS  src/services/oauth/routes.test.ts
 PASS  src/services/llm-bot/__tests__/personality-resolver-sorting.spec.ts
 PASS  tests/apps/command-processor-error-policy.spec.ts
 PASS  src/common/base-server.debug-config.test.ts
 PASS  src/apps/oauth-service.test.ts
 PASS  src/apps/persistence-service.test.ts
 PASS  src/apps/ingress-egress-service.finalize.spec.ts
 PASS  tools/brat/src/orchestration/errors.spec.ts
 PASS  src/apps/__tests__/command-processor-service.test.ts
 PASS  src/services/twitch-oauth.test.ts
 PASS  infrastructure/scripts/extract-config.test.ts
 PASS  src/apps/oauth-service.oauth-routes.test.ts
 PASS  src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts
 PASS  src/types/events.types.test.ts
 PASS  src/apps/command-processor-service.test.ts
 PASS  tests/services/llm-bot/history-redundancy.test.ts
 PASS  src/common/__tests__/base-server-helpers.test.ts
 PASS  src/apps/scheduler-service.test.ts
 PASS  src/services/oauth/providers/discord-adapter.test.ts
 PASS  src/services/llm-bot/__tests__/processor.personality-name.spec.ts
 PASS  src/services/auth/__tests__/user-repo.spec.ts
 PASS  src/services/llm-bot/processor.personality-disabled.spec.ts
 PASS  src/apps/auth-service.test.ts
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From src/apps/__tests__/ingress-egress-routing.test.ts.
      at new PublisherClient (node_modules/@google-cloud/pubsub/src/v1/publisher_client.ts:161:21)
      at PubSub.getClientAsync_ (node_modules/@google-cloud/pubsub/src/pubsub.ts:1316:19)
 PASS  tests/base-server-step-update.spec.ts
 PASS  tests/services/llm-bot/mcp/client-manager.spec.ts
 PASS  src/services/llm-bot/__tests__/user-context.append.spec.ts
 PASS  src/services/message-bus/nats-driver.test.ts
 PASS  src/services/ingress/twitch/__tests__/token-overwrite.spec.ts
 PASS  src/apps/llm-bot-service.test.ts
 PASS  tests/llm-bot-service.spec.ts
 PASS  tests/services/message-bus/pubsub-logging.spec.ts
 PASS  src/common/__tests__/base-server-yaml.test.ts
 PASS  src/services/llm-bot/__tests__/processor.unwrap-quotes.spec.ts
 PASS  src/services/oauth/oauth-flow.integration.test.ts
 PASS  tools/brat/src/cli/trigger.spec.ts
 PASS  src/common/__tests__/discord-secret.test.ts
 PASS  tests/services/llm-bot/personality-with-memory.spec.ts
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/apps/command-processor-error-policy.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
 PASS  src/services/persistence/integration.spec.ts
 PASS  tests/prompt-assembly/conversation-state.spec.ts
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/services/command-processor/routing-advance.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
 PASS  src/services/ingress/twilio/__tests__/token-provider.spec.ts
 PASS  tests/base-server-routing.spec.ts
 PASS  src/services/llm-bot/__tests__/processor.personality-mixed.spec.ts
 PASS  tests/common/retry.spec.ts
 PASS  tests/base-server-onmessage.spec.ts
 PASS  tests/services/command-processor/template-selection.spec.ts
 PASS  src/services/llm-bot/reducer.spec.ts
 PASS  src/apps/event-router-service.test.ts
 PASS  tests/services/command-processor/personality-annotation-regex.spec.ts
 PASS  src/apps/__tests__/event-router-ingress.integration.test.ts
 PASS  src/services/ingress/twilio/__tests__/twilio-ingress-client.spec.ts
 PASS  tests/services/command-processor/logging.spec.ts
 PASS  src/services/router/__tests__/jsonlogic-slip-complete.spec.ts
 PASS  src/services/routing/__tests__/router-engine.test.ts
 PASS  src/services/ingress/twitch/publisher.spec.ts
 PASS  src/services/ingress/twitch/credentials-provider.config.spec.ts
 PASS  src/apps/__tests__/event-router-debug.test.ts
 PASS  src/services/ingress/twitch/credentials-provider.spec.ts
 PASS  tests/common/base-server-get-resource.spec.ts
 PASS  tests/services/command-processor/policy-rate-limit.spec.ts
 PASS  src/services/ingress/discord/discord-ingress-client.spec.ts
 PASS  tests/prompt-assembly/redaction.spec.ts
 PASS  tests/services/command-processor/policy-user-cooldown.spec.ts
 PASS  tests/common/base-server-resources.spec.ts
 PASS  tools/brat/src/lb/importer/__tests__/importer.test.ts
 PASS  src/services/ingress/discord/discord-ingress-client.test.ts
 PASS  src/services/router/__tests__/rule-loader.test.ts
 PASS  tests/services/message-bus/nats-logging.spec.ts
 PASS  tests/services/command-processor/processor.spec.ts
 PASS  tests/services/command-processor/parsing.spec.ts
 PASS  tests/services/command-processor/policy-global-cooldown.spec.ts
 PASS  tests/services/command-processor/command-repo.spec.ts
 PASS  tests/services/llm-bot/processor.spec.ts
 PASS  src/common/firebase.test.ts
 PASS  tests/integration/command-processor-smoke.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/load-from-arch.test.ts
 PASS  src/services/llm-bot/instance-memory.spec.ts
 PASS  tests/services/llm-bot/prompt-logging.test.ts
 PASS  src/services/router/__tests__/rule-loader-annotations.spec.ts
 PASS  tests/services/message-bus/nats-attributes.spec.ts
 PASS  src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.connectors.spec.ts
 PASS  src/services/twitch-token-manager.test.ts
 PASS  src/common/base-server.logger.test.ts
 PASS  src/services/oauth/auth-token-store.test.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/renderer.routing.test.ts
 PASS  src/services/llm-bot/__tests__/prompt-composer.spec.ts
 PASS  src/services/ingress/twitch/__tests__/twurple-integration.spec.ts
 PASS  src/services/ingress/twitch/twitch-irc-client.spec.ts
 PASS  src/common/__tests__/logging-trace-correlation.spec.ts
 PASS  src/common/logging.test.ts
 PASS  tests/services/command-processor/personality-annotation.spec.ts
 PASS  src/services/router/__tests__/jsonlogic-evaluator.test.ts
 PASS  src/services/ingress/discord/discord-observability.spec.ts
 PASS  tests/services/command-processor/template-render.spec.ts
 PASS  tests/services/message-bus/subscriber-dedupe.spec.ts
 PASS  tools/brat/src/providers/gcp/lb-preflight.spec.ts
 PASS  tests/services/message-bus/pubsub-batching.spec.ts
 PASS  src/services/router/__tests__/rule-loader.hardening.test.ts
 PASS  src/services/routing/__tests__/router-engine-annotations.spec.ts
 PASS  tests/prompt-assembly/truncation.spec.ts
 PASS  tests/common/firestore-manager.spec.ts
 PASS  tools/brat/src/cli/__tests__/deploy-substitutions.scaling.test.ts
 PASS  src/services/routing/__tests__/router-engine-ops-integration.spec.ts
 PASS  src/services/ingress/discord/discord-integration.spec.ts
 PASS  tools/brat/src/providers/cdktf-synth.restore.test.ts
 PASS  src/services/ingress/twilio/__tests__/webhook-utils.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/renderer.test.ts
 PASS  tests/prompt-assembly/assemble.spec.ts
 PASS  tools/brat/src/providers/gcp/secrets.spec.ts
 PASS  tools/brat/src/config/loader.spec.ts
 PASS  src/services/message-bus/__tests__/pubsub-publisher-logging.test.ts
 PASS  tools/brat/src/providers/gcp/preflight.spec.ts
 PASS  tests/common/publisher-manager.spec.ts
 PASS  tests/services/llm-bot/processor-tools.spec.ts
 PASS  src/services/ingress/twitch/__tests__/eventsub-envelope-builder.spec.ts
 PASS  tools/brat/src/providers/cdktf-synth.network.spec.ts
 PASS  tests/services/message-bus/nats-flush.spec.ts
 PASS  tools/brat/src/config/__tests__/interpolation.test.ts
 PASS  tools/brat/src/config/schema.network.spec.ts
 PASS  src/services/ingress/twilio/__tests__/twilio-envelope-builder.spec.ts
 PASS  src/common/config.test.ts
 PASS  tools/brat/src/config/schema.spec.ts
 PASS  src/services/oauth/providers/twitch-adapter.test.ts
 PASS  src/services/auth/__tests__/user-repo.test.ts
 PASS  tools/brat/src/config/__tests__/allow-unauth.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.spec.ts
 PASS  tools/brat/src/config/schema.test.ts
 PASS  tests/prompt-assembly/adapters/edge-cases.spec.ts
 PASS  infrastructure/cdktf/network/config.spec.ts
 PASS  tools/brat/src/lb/importer/__tests__/importer.guard.test.ts
 PASS  tools/brat/src/providers/gcp/apis.spec.ts
 PASS  src/services/llm-bot/__tests__/personality-metrics.spec.ts
 PASS  tools/brat/src/config/__tests__/resolve-services.scaling.test.ts
 PASS  src/services/router/__tests__/jsonlogic-re-test.spec.ts
 PASS  tests/services/command-processor/candidate-create.spec.ts
 PASS  src/services/oauth/provider-registry.test.ts
 PASS  tests/services/egress/selection.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.lb.spec.ts
 PASS  src/services/llm-bot/__tests__/personality-resolver.spec.ts
 PASS  src/services/message-bus/__tests__/factory-selection.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.buckets.test.ts
 PASS  src/services/routing/routing.dlq.test.ts
 PASS  tests/router-annotations-e2e.spec.ts
 PASS  tests/services/llm-bot/tools/registry.spec.ts
 PASS  tests/prompt-assembly/adapters/google.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/from-repo-arch.test.ts
 PASS  tests/prompt-assembly/adapters/openai.spec.ts
 PASS  src/common/__tests__/discord-config.test.ts
 PASS  src/services/llm-bot/tools/__tests__/internal-tools.test.ts
 PASS  tests/common/events/attributes.spec.ts
 PASS  tests/prompt-assembly/adapters.spec.ts
 PASS  src/services/ingress/discord/envelope-builder.spec.ts
 PASS  src/services/ingress/twitch/envelope-builder.spec.ts
 PASS  src/services/persistence/model.spec.ts
 PASS  src/services/routing/routing.slip.test.ts
 PASS  src/services/router/__tests__/jsonlogic-ci-eq.spec.ts
 PASS  src/services/message-bus/message-bus.test.ts
 PASS  tools/brat/src/providers/gcp/cloudbuild-triggers.spec.ts
 PASS  tools/brat/src/providers/gcp/cloudrun.spec.ts
 PASS  src/services/message-bus/__tests__/subscriber-options.test.ts
 PASS  infrastructure/scripts/bootstrap-service.test.js
 PASS  tests/services/llm-bot/mcp/stats-collector.spec.ts
 PASS  src/services/router/__tests__/jsonlogic-extra-ops.spec.ts
 PASS  src/common/feature-flags.test.ts
 PASS  tools/brat/src/providers/gcp/cloudbuild.spec.ts
 PASS  tests/services/message-bus/normalize-attributes.spec.ts
 PASS  tests/services/message-bus/pubsub-attributes.spec.ts
 PASS  tests/prompt-assembly/openai-adapter.spec.ts
 PASS  tests/services/llm-bot/mcp/bridge.spec.ts
A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 2 skipped, 192 passed, 192 of 194 total
Tests:       10 skipped, 553 passed, 563 total
Snapshots:   2 passed, 2 total
Time:        16.281 s
âœ… Validation complete.
