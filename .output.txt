      {"ts":"2025-12-29T21:25:09.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-s4za3kvv","queue":"ingress-egress.proc-s4za3kvv"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.006Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-s4za3kvv","queue":"ingress-egress.proc-s4za3kvv"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.006Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-s4za3kvv","subscription":"internal.egress.v1.proc-s4za3kvv.ingress-egress.proc-s4za3kvv","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.508Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-1","candidateId":"cand-1","priority":1,"createdAt":"2025-12-29T21:25:09.507Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-1","source":"ingress.discord","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.512Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-1","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.513Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.513Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.513Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.513Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.513Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-fvosf88h","queue":"ingress-egress.proc-fvosf88h"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-fvosf88h","queue":"ingress-egress.proc-fvosf88h"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:09.514Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-fvosf88h","subscription":"internal.egress.v1.proc-fvosf88h.ingress-egress.proc-fvosf88h","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.015Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-3","candidateId":"cand-3","priority":1,"createdAt":"2025-12-29T21:25:10.015Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.015Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-3","source":"command-processor","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.015Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-3","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.016Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.016Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.016Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.017Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.017Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.017Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.017Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-8wk0ve9b","queue":"ingress-egress.proc-8wk0ve9b"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-8wk0ve9b","queue":"ingress-egress.proc-8wk0ve9b"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.018Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-8wk0ve9b","subscription":"internal.egress.v1.proc-8wk0ve9b.ingress-egress.proc-8wk0ve9b","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.518Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-v1","source":"ingress.discord","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.519Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-v1","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.520Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.521Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-fqsy7v9w","queue":"ingress-egress.proc-fqsy7v9w"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.522Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.523Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-fqsy7v9w","queue":"ingress-egress.proc-fqsy7v9w"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:10.523Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-fqsy7v9w","subscription":"internal.egress.v1.proc-fqsy7v9w.ingress-egress.proc-fqsy7v9w","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-2","candidateId":"cand-2","priority":1,"createdAt":"2025-12-29T21:25:11.023Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-2","source":"ingress.twitch","isDiscord":false,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-2","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.027Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-imc4jk5x","queue":"ingress-egress.proc-imc4jk5x"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.027Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.027Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-imc4jk5x","queue":"ingress-egress.proc-imc4jk5x"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.027Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-imc4jk5x","subscription":"internal.egress.v1.proc-imc4jk5x.ingress-egress.proc-imc4jk5x","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.527Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-twilio","candidateId":"cand-twilio","priority":1,"createdAt":"2025-12-29T21:25:11.527Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.528Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-twilio","source":"ingress.twilio","isDiscord":false,"isTwilio":true}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.528Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-twilio","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/ingress/twitch/__tests__/eventsub-client.repro.spec.ts (6.085 s)
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:11.500Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["broadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.514Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.aliasing_bot_token","broadcasterId":"broadcaster-id","botId":"bot-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.514Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.515Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["broadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.516Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.aliasing_bot_token","broadcasterId":"broadcaster-id","botId":"bot-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.516Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.516Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["realbroadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.516Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.broadcaster_auth_found","userId":"real-broadcaster-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.516Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.517Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["broadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.517Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.aliasing_bot_token","broadcasterId":"broadcaster-id","botId":"bot-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.517Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.517Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.event.stream_online","channel":"broadcaster","streamId":"12345"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.518Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["broadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.518Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.aliasing_bot_token","broadcasterId":"broadcaster-id","botId":"bot-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.518Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-29T21:25:11.573Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twitch.eventsub.handler_error","kind":"stream.online","channel":"broadcaster","error":"Cannot read properties of null (reading 'id')","stack":"TypeError: Cannot read properties of null (reading 'id')\n    at /Users/christophernavta/IdeaProjects/BitBratPlatform/src/services/ingress/twitch/eventsub-client.ts:170:91\n    at Object.<anonymous> (/Users/christophernavta/IdeaProjects/BitBratPlatform/src/services/ingress/twitch/__tests__/eventsub-client.repro.spec.ts:210:11)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/services/ingress/twitch/eventsub-client.ts:178:20
      at Object.<anonymous> (src/services/ingress/twitch/__tests__/eventsub-client.repro.spec.ts:210:11)
    console.log
      {"ts":"2025-12-29T21:25:11.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.starting","channels":["broadcaster"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.aliasing_bot_token","broadcasterId":"broadcaster-id","botId":"bot-id"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.574Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.574Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch.eventsub.stopped"}
      at Logger.info (src/common/logging.ts:142:13)
(node:83916) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:83907) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twilio/__tests__/twilio-ingress-client.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:11.687Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.689Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.690Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.690Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.690Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message added event","sid":"IM123","conversationSid":"CH456","author":"so***else"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Received Twilio message (processing)","author":"so***else","conversationSid":"CH456","body":"Hello"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message published to internal bus","correlationId":"c1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message added event","sid":"IM123","conversationSid":"CH456","author":"bo***tity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.691Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio client state changed","state":"synchronized"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio subscribed conversations","count":1,"sids":["CH_INVITED"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.692Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited (on sync), joining...","sid":"CH_INVITED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_JOIN","status":"invited"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited, joining...","sid":"CH_JOIN"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"Failed to join Twilio conversation","sid":"CH_JOIN","error":"conversation.join is not a function"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/services/ingress/twilio/twilio-ingress-client.ts:162:20
      at Object.<anonymous> (src/services/ingress/twilio/__tests__/twilio-ingress-client.spec.ts:138:11)
    console.log
      {"ts":"2025-12-29T21:25:11.693Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation joined (client event)","sid":"CH_JOIN","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_UPDATE","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio bot joined conversation","identity":"bot-identity","sid":"PA123","conversationSid":"CH123"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.694Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_LATER","status":"invited"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited, joining...","sid":"CH_LATER"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_NEW","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.695Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation removed","sid":"CH_NEW"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.696Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.696Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.696Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client stopped"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/ingress/twilio/__tests__/twilio-envelope-builder.spec.ts
 PASS  tools/brat/src/config/schema.routing.test.ts (6.159 s)
(node:83908) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:83917) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From src/apps/__tests__/ingress-egress-routing.test.ts.
      at new PublisherClient (node_modules/@google-cloud/pubsub/src/v1/publisher_client.ts:161:21)
      at PubSub.getClientAsync_ (node_modules/@google-cloud/pubsub/src/pubsub.ts:1316:19)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.717Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"internal.egress.v1.proc-fqsy7v9w","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.720Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"internal.egress.v1.proc-fqsy7v9w","subscription":"internal.egress.v1.proc-fqsy7v9w.ingress-egress.proc-fqsy7v9w","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.722Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.egress.v1.proc-fqsy7v9w.ingress-egress.proc-fqsy7v9w"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:290:12)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.723Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.egress.v1.proc-fqsy7v9w","queue":"ingress-egress.proc-fqsy7v9w"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onMessage (src/common/base-server.ts:318:19)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.723Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-fqsy7v9w"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:279:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.724Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:286:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:292:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:306:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.727Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
      at IngressEgressServer.startStatusMonitoring (src/apps/ingress-egress-service.ts:326:10)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:320:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:11.739Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"pubsub.subscription.error","subscription":"internal.egress.v1.proc-fqsy7v9w.ingress-egress.proc-fqsy7v9w","details":"TypeError: this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at Subscription.onError (src/services/message-bus/pubsub-driver.ts:372:14)
      at Subscriber.<anonymous> (node_modules/@google-cloud/pubsub/src/subscription.ts:338:32)
      at MessageStream.<anonymous> (node_modules/@google-cloud/pubsub/src/subscriber.ts:1181:32)
(node:83914) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/services/llm-bot/prompt-logging.test.ts (6.375 s)
 PASS  tests/base-server-routing.spec.ts (6.517 s)
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:11.863Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.904Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.906Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.910Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.912Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.912Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.915Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.916Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.step2.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.916Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.916Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.917Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.917Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.917Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.918Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.918Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.918Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.918Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.919Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.919Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.919Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.919Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.920Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.920Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.920Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.921Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.921Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.921Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:11.973Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":1,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
(node:83913) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/services/command-processor/processor.spec.ts (6.557 s)
  ● Console
    console.warn
      {"ts":"2025-12-29T21:25:12.037Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:30:35)
    console.log
      {"ts":"2025-12-29T21:25:12.051Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.051Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"ping","id":"cmd1","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.051Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.052Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:12.053Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:56:35)
    console.log
      {"ts":"2025-12-29T21:25:12.053Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"note","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.053Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"note","id":"cmdA","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.053Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.effect.added","effect":"annotation","name":"note","kind":"prompt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:12.054Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:79:35)
    console.log
      {"ts":"2025-12-29T21:25:12.054Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"cool","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.054Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"cool","id":"cmd3","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:12.054Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:99:35)
    console.log
      {"ts":"2025-12-29T21:25:12.054Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"missing","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:12.055Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:118:35)
    console.log
      {"ts":"2025-12-29T21:25:12.055Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"rate","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.055Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"rate","id":"cmd2","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:12.055Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:147:35)
(node:83915) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twilio/__tests__/token-provider.spec.ts
  ● Console
    console.error
      {"ts":"2025-12-29T21:25:12.067Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twilio.token_provider.config_missing","missing":["twilioAccountSid","twilioApiKey","twilioApiSecret","twilioChatServiceSid"]}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioTokenProvider.generateToken (src/services/ingress/twilio/token-provider.ts:22:14)
      at src/services/ingress/twilio/__tests__/token-provider.spec.ts:22:27
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/services/ingress/twilio/__tests__/token-provider.spec.ts:22:50)
(node:83909) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:83911) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/llm-bot-service.spec.ts (6.974 s)
(node:83912) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/services/command-processor/routing-advance.spec.ts (7.056 s)
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:11.965Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.007Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.007Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.008Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.009Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.286Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.286Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.434Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.published","subject":"dev.internal.egress.v1","stepIndex":1,"attempt":0,"correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.436Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.443Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.443Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.462Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.462Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.462Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.465Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.564Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"dev.internal.egress.v1.dev1","correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.565Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.565Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.565Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.565Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.566Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.566Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.567Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.597Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"internal.egress.v1.proc-imc4jk5x","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.599Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"internal.egress.v1.proc-imc4jk5x","subscription":"internal.egress.v1.proc-imc4jk5x.ingress-egress.proc-imc4jk5x","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:7)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.602Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.egress.v1.proc-imc4jk5x.ingress-egress.proc-imc4jk5x"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:290:12)
      at IngressEgressServer.onMessage (src/common/base-server.ts:291:27)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.602Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.egress.v1.proc-imc4jk5x","queue":"ingress-egress.proc-imc4jk5x"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onMessage (src/common/base-server.ts:318:19)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:160:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.603Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-imc4jk5x"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:279:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.603Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:286:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.604Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:292:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.604Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.onHTTPRequest (src/common/base-server.ts:253:17)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:306:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.604Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
      at IngressEgressServer.startStatusMonitoring (src/apps/ingress-egress-service.ts:326:10)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:320:10)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:12.605Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"pubsub.subscription.error","subscription":"internal.egress.v1.proc-imc4jk5x.ingress-egress.proc-imc4jk5x","details":"TypeError: this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at Subscription.onError (src/services/message-bus/pubsub-driver.ts:372:14)
      at Subscriber.<anonymous> (node_modules/@google-cloud/pubsub/src/subscription.ts:338:32)
      at MessageStream.<anonymous> (node_modules/@google-cloud/pubsub/src/subscriber.ts:1181:32)
 PASS  src/services/oauth/routes.test.ts (7.291 s)
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.504Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"mockprov","identity":"bot","mode":"json"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.672Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"mockprov","identity":"bot","mode":"redirect"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-29T21:25:12.734Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"oauth.routes.start.error","error":"unknown_provider:unknown"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/services/oauth/routes.ts:43:14
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)
    console.log
      {"ts":"2025-12-29T21:25:12.749Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"mockprov","identity":"bot","stored":false,"tokenType":"***"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.757Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"mockprov","identity":"bot","status":"absent"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.761Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"mockprov","identity":"bot","stored":true,"tokenType":"***"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.763Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"mockprov","identity":"bot","status":"present"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/ingress-egress-service.finalize.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.923Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.952Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.958Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.958Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.964Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.966Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.969Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-29T21:25:13.302Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"connector.start_error","name":"twitch","error":"twitch_auth_missing"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:39:34)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:147:7)
    console.log
      {"ts":"2025-12-29T21:25:13.303Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.303Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.303Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-24tlnz2v","queue":"ingress-egress.proc-24tlnz2v"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.303Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.ok","subject":"internal.egress.v1.proc-24tlnz2v"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.304Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.304Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.304Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.305Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.305Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.309Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.312Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"fx-1","candidateId":"c1","priority":1,"createdAt":"2025-12-29T21:25:13.310Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.313Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"fx-1","source":"","isDiscord":false,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.317Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"fx-1","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.402Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.403Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.403Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twitch","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.404Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twitch","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.404Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"ERROR"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.405Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"ERROR"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.425Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.426Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.426Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twitch-eventsub","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.427Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twitch-eventsub","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.427Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.427Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.449Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.450Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.451Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"discord","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.451Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"discord","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.451Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.451Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"CONNECTED"}".
      140 |   info(msg: string, context?: Record<string, unknown>) {
      141 |     if (!this.shouldLog('info')) return;
    > 142 |     console.log(JSON.stringify(this.base({ level: 'info', severity: this.severityOf('info'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      143 |   }
      144 |
      145 |   debug(msg: string, context?: Record<string, unknown>) {
      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at Logger.info (src/common/logging.ts:142:13)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:337:16)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.474Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.475Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"message_publisher.publish.error","driver":"pubsub","topic":"internal.ingress.v1","error":"this._gaxModule.GrpcClient is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at PubSubPublisher.publishJson (src/services/message-bus/pubsub-driver.ts:233:14)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:377:7)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.476Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twilio","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-29T21:25:13.476Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"ingress-egress.publish_status_failed","name":"twilio","error":"this._gaxModule.GrpcClient is not a constructor"}".
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at console.warn (node_modules/@jest/console/build/BufferedConsole.js:191:10)
      at Logger.warn (src/common/logging.ts:137:13)
      at IngressEgressServer.publishStatus (src/apps/ingress-egress-service.ts:383:14)
      at IngressEgressServer.checkStatusChanges (src/apps/ingress-egress-service.ts:339:9)
 PASS  src/apps/ingress-egress-service.krevision.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:13.392Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.410Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.411Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.413Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.463Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.491Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.492Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.496Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.500Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.500Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/ingress-egress-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:13.425Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.501Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.506Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.530Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.534Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.535Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.536Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.536Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.536Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.537Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.537Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.537Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.539Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.539Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
(node:84032) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tests/services/llm-bot/mcp/web-search.test.ts
  ● Console
    console.log
      mcp_search_web schema: {
        "jsonSchema": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string"
            },
            "limit": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10
            }
          },
          "required": [
            "query"
          ],
          "additionalProperties": false,
          "$schema": "http://json-schema.org/draft-07/schema#"
        }
      }
      at Object.<anonymous> (tests/services/llm-bot/mcp/web-search.test.ts:37:13)
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/services/command-processor/routing-advance.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
 PASS  src/apps/llm-bot-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:14.005Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.006Z","service":"llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.006Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.007Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.007Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/apps/command-processor-error-policy.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:13.832Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.835Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.836Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.836Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.837Z","service":"command-processor","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.839Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.840Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.842Z","service":"command-processor","level":"info","severity":"INFO","msg":"regex_cache.start"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.077Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.regex_cache.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.078Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.078Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.078Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-29T21:25:14.276Z","service":"command-processor","level":"error","severity":"ERROR","msg":"base_server.message.handler_error","subject":"dev.internal.command.v1","error":"Expected property name or '}' in JSON at position 1 (line 1 column 2)"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at subscriber.subscribe (src/common/base-server.ts:311:25)
      at Object.<anonymous> (tests/apps/command-processor-error-policy.spec.ts:62:5)
 PASS  tools/brat/src/orchestration/exec.spec.ts
 PASS  src/services/llm-bot/__tests__/processor.personality-mixed.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:14.748Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.752Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.752Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/common/mcp-server.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:14.601Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.609Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.610Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.616Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.616Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.635Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.650Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.655Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.655Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.656Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.658Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.658Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.658Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.662Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.662Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.664Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.665Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.665Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.665Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.665Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.667Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.669Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.670Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.673Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.674Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:14.677Z","service":"test-mcp-server","level":"warn","severity":"WARNING","msg":"mcp_server.auth_failed","path":"/sse","ip":"::ffff:127.0.0.1"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at authMiddleware (src/common/mcp-server.ts:162:28)
      at src/common/mcp-server.ts:174:7
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)
    console.log
      {"ts":"2025-12-29T21:25:14.679Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.680Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.680Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.681Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.682Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.683Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.688Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.689Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:14.690Z","service":"test-mcp-server","level":"warn","severity":"WARNING","msg":"mcp_server.auth_failed","path":"/sse","ip":"::ffff:127.0.0.1"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at authMiddleware (src/common/mcp-server.ts:162:28)
      at src/common/mcp-server.ts:174:7
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at app.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)
    console.log
      {"ts":"2025-12-29T21:25:14.691Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.692Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.692Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.693Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.694Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.695Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.699Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.701Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.703Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.704Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.704Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.704Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.705Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.705Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.705Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.706Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.713Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.714Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.715Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.sse_connection_attempt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.716Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.connected","sessionId":"test-session"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.717Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":1}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.717Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.717Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.718Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.718Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.718Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.724Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.740Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.769Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.785Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.800Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.832Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.848Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.885Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.900Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.916Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.927Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.976Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.976Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.979Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.980Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.982Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.tool_registered","name":"test_tool"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.982Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.983Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.983Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.983Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.983Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.983Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.985Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.985Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.986Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.resource_registered","name":"test_resource","uri":"file://test"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.986Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.986Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.986Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.986Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.987Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.987Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.988Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/sse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.988Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/message"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.989Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.prompt_registered","name":"test_prompt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.989Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"mcp_server.closing","reason":"manual","activeTransports":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.989Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:14.989Z","service":"test-mcp-server","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
(node:83910) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGTERM listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:83910) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:83910) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 beforeExit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:83910) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 exit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
 PASS  src/types/events.types.test.ts
 PASS  src/services/llm-bot/processor.personality.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.773Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.779Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.782Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.783Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  infrastructure/scripts/extract-config.test.ts
 PASS  tests/common/base-server-resources.spec.ts
 PASS  src/apps/persistence-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.405Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.407Z","service":"persistence","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.407Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.407Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.ingress.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.ingress.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.ingress.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.persistence.finalize.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.persistence.finalize.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.persistence.finalize.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.deadletter.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.deadletter.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.deadletter.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.router.dlq.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.router.dlq.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.408Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.router.dlq.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/persistence/integration.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.437Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.443Z","service":"persistence","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.443Z","service":"persistence","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.444Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.ingress.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.444Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.persistence.finalize.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.444Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.deadletter.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.444Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.subscribe.ok","destination":"internal.router.dlq.v1","queue":"persistence"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.445Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.ingress.v1","type":"chat.message.v1","correlationId":"it-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.445Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.upsert.ok","correlationId":"it-1","status":"INGESTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.450Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-2"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.450Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-2","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.450Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-3"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.451Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-3","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.451Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.message.received","destination":"internal.persistence.finalize.v1","correlationId":"it-ttl-seconds"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.451Z","service":"persistence","level":"info","severity":"INFO","msg":"persistence.finalize.ok","correlationId":"it-ttl-seconds","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/llm-bot/processor.personality-disabled.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.778Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.785Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.787Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.790Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/llm-bot/processor.memory.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.713Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.733Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.735Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:12.738Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.427Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.428Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.429Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.486Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.486Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.486Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/llm-bot/__tests__/processor.unwrap-quotes.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.539Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.540Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.540Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/oauth-service.oauth-routes.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.517Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.521Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.522Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.524Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/llm-bot/personality-with-memory.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:12.934Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/__tests__/event-router-debug.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.650Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.651Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.651Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.652Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.652Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.653Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.653Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.658Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.658Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.662Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.662Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.662Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.662Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.663Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.663Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.663Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.663Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.663Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.667Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tools/brat/src/cli/trigger.spec.ts
 PASS  tests/base-server-step-update.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.715Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.716Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.716Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.718Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.718Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.718Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.719Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.719Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.719Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.719Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.720Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.720Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.720Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.720Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.721Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/oauth/auth-token-store.test.ts
 PASS  src/services/llm-bot/processor.empty-response.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:13.304Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.307Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.307Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:13.310Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.700Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.702Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.702Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/__tests__/discord-secret.test.ts
 PASS  tests/prompt-assembly/truncation.spec.ts
 PASS  tests/services/llm-bot/mcp/bridge.spec.ts
 PASS  src/common/base-server.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.778Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.784Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.784Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.832Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.832Z","service":"custom","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.832Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/__tests__/base-server-helpers.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.775Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.776Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.776Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.778Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/ping"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.779Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/echo"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.861Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.862Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.862Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/__tests__/base-server-yaml.test.ts
 PASS  src/common/base-server.debug-config.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.893Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.894Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.894Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/message-bus/subscriber-dedupe.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.918Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.921Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.test.v1","subscription":"internal.test.v1.q","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.921Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.test.v1.q"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-29T21:25:15.921Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"message_consumer.dedupe.drop","driver":"pubsub","subscription":"internal.test.v1.q","idempotencyKey":"***","ttlMs":60000}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at SubscriptionMock.onMessage (src/services/message-bus/pubsub-driver.ts:338:22)
      at Object.<anonymous> (tests/services/message-bus/subscriber-dedupe.spec.ts:47:26)
 PASS  src/services/oauth/oauth-flow.integration.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.894Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"twitch","identity":"bot","mode":"redirect"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.903Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.start","provider":"twitch","identity":"bot","mode":"json"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.914Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.callback.success","provider":"twitch","identity":"bot","stored":true,"tokenType":"***","providerUserId":"u-123"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.923Z","service":"bitbrat","level":"info","severity":"INFO","msg":"oauth.routes.status","provider":"twitch","identity":"bot","status":"present"}
      at Logger.info (src/common/logging.ts:142:13)
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/apps/command-processor-error-policy.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
 PASS  src/common/firebase.test.ts
 PASS  tools/brat/src/config/loader.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:151:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:151:15)
 PASS  src/apps/oauth-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.969Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.970Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.970Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.970Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/llm-bot/processor-tools.spec.ts
 PASS  src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.965Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.965Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.965Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.subscription.created","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.965Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/event-router-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-29T21:25:15.987Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.989Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.989Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.989Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.989Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.990Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.994Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-29T21:25:15.995Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
 RUNS  src/apps/auth-service.test.ts
 RUNS  tests/base-server-onmessage.spec.ts
 RUNS  tests/services/command-processor/policy-user-cooldown.spec.ts
 RUNS  src/apps/__tests__/command-processor-service.test.ts
 RUNS  src/services/llm-bot/processor.error.spec.ts
 RUNS  src/apps/event-router-service.test.ts
 RUNS  src/services/llm-bot/processor.instance-memory.spec.ts
 RUNS  tests/services/llm-bot/processor-tools.spec.ts
 RUNS  src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
 RUNS  src/services/llm-bot/processor.test.ts
 RUNS  src/apps/command-processor-service.test.ts
Test Suites: 2 skipped, 50 passed, 50 of 190 total
Tests:       10 skipped, 171 passed, 181 total
Snapshots:   0 total
Time:        10 s
LINE LIMIT EXCEEDED