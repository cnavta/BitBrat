
> bitbrat-platform@1.0.0 test
> jest src/services/ingress/twilio src/apps/__tests__/ingress-egress-webhooks.test.ts src/apps/__tests__/ingress-egress-routing.test.ts
(node:86682) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twilio/__tests__/twilio-ingress-client.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-30T19:45:16.534Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.551Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.556Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.557Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.557Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message added event","sid":"IM123","conversationSid":"CH456","author":"so***else"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.558Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Received Twilio message (processing)","author":"so***else","conversationSid":"CH456","body":"Hello"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.559Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message published to internal bus","correlationId":"c1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.560Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.562Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.562Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio message added event","sid":"IM123","conversationSid":"CH456","author":"bo***tity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.565Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.568Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.569Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.570Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.570Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio client state changed","state":"synchronized"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.570Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio subscribed conversations","count":1,"sids":["CH_INVITED"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.570Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited (on sync), joining...","sid":"CH_INVITED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.570Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_JOIN","status":"invited"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited, joining...","sid":"CH_JOIN"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation joined (client event)","sid":"CH_JOIN","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.571Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_UPDATE","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio bot joined conversation","identity":"bot-identity","sid":"PA123","conversationSid":"CH123"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_LATER","status":"invited"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.572Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation invited, joining...","sid":"CH_LATER"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation added","sid":"CH_NEW","status":"joined"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.573Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio conversation removed","sid":"CH_NEW"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.574Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"bot-identity"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.574Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client connected and listening"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.574Z","service":"bitbrat","level":"info","severity":"INFO","msg":"Twilio Ingress Client stopped"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/ingress/twilio/__tests__/token-provider.spec.ts
  ● Console
    console.error
      {"ts":"2025-12-30T19:45:16.561Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twilio.token_provider.config_missing","missing":["twilioAccountSid","twilioApiKey","twilioApiSecret","twilioChatServiceSid"]}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioTokenProvider.generateToken (src/services/ingress/twilio/token-provider.ts:22:14)
      at src/services/ingress/twilio/__tests__/token-provider.spec.ts:22:27
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/services/ingress/twilio/__tests__/token-provider.spec.ts:22:50)
(node:86681) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:86683) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twilio/__tests__/webhook-utils.spec.ts
  ● Console
    console.error
      {"ts":"2025-12-30T19:45:16.792Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twilio.signature_validation_error","error":"Validation failed"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at validateTwilioSignature (src/services/ingress/twilio/webhook-utils.ts:20:12)
      at Object.<anonymous> (src/services/ingress/twilio/__tests__/webhook-utils.spec.ts:32:45)
(node:86684) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twilio/__tests__/twilio-envelope-builder.spec.ts
(node:86680) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:86679) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/apps/__tests__/ingress-egress-webhooks.test.ts (5.651 s)
  ● Console
    console.log
      {"ts":"2025-12-30T19:45:16.961Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.974Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.974Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.976Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.977Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.979Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.979Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.979Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.980Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.981Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.981Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:16.981Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"BotUser"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-30T19:45:17.154Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"Failed to initialize Twilio Conversations client","error":"Cannot read properties of undefined (reading 'AccessToken')"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioIngressClient.start (src/services/ingress/twilio/twilio-ingress-client.ts:230:14)
      at TwilioConnectorAdapter.start (src/services/ingress/twilio/connector-adapter.ts:12:23)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:35:30)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:209:7)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.155Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.491Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.received","EventType":"onConversationAdded","ConversationSid":"CH123"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.494Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot","ConversationSid":"CH123","botIdentity":"BotUser","trigger":"onConversationAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.494Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot.ok","ConversationSid":"CH123","trigger":"onConversationAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.497Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.498Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.498Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.498Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.498Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.498Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"BotUser"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"Failed to initialize Twilio Conversations client","error":"Cannot read properties of undefined (reading 'AccessToken')"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioIngressClient.start (src/services/ingress/twilio/twilio-ingress-client.ts:230:14)
      at TwilioConnectorAdapter.start (src/services/ingress/twilio/connector-adapter.ts:12:23)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:35:30)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:209:7)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.499Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.001Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.received","EventType":"onMessageAdded","ConversationSid":"CH456"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.002Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot","ConversationSid":"CH456","botIdentity":"BotUser","trigger":"onMessageAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.002Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot.ok","ConversationSid":"CH456","trigger":"onMessageAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.003Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.003Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.003Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.004Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"BotUser"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"Failed to initialize Twilio Conversations client","error":"Cannot read properties of undefined (reading 'AccessToken')"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioIngressClient.start (src/services/ingress/twilio/twilio-ingress-client.ts:230:14)
      at TwilioConnectorAdapter.start (src/services/ingress/twilio/connector-adapter.ts:12:23)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:35:30)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:209:7)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.005Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.507Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.received","EventType":"onMessageAdded","ConversationSid":"CH789"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.507Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot","ConversationSid":"CH789","botIdentity":"BotUser","trigger":"onMessageAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.507Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.webhook.inject_bot.already_participant","ConversationSid":"CH789","trigger":"onMessageAdded"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.508Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.508Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.508Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twitch.eventsub.disabled","reason":"config or test env"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.509Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Starting Twilio Ingress Client","identity":"BotUser"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"error","severity":"ERROR","msg":"Failed to initialize Twilio Conversations client","error":"Cannot read properties of undefined (reading 'AccessToken')"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at TwilioIngressClient.start (src/services/ingress/twilio/twilio-ingress-client.ts:230:14)
      at TwilioConnectorAdapter.start (src/services/ingress/twilio/connector-adapter.ts:12:23)
      at ConnectorManager.start (src/services/ingress/core/connector-manager.ts:35:30)
      at IngressEgressServer.setupApp (src/apps/ingress-egress-service.ts:209:7)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twitch-eventsub","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"discord","from":"NONE","to":"CONNECTED"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.510Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.status_change","name":"twilio","from":"NONE","to":"ERROR"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-30T19:45:19.011Z","service":"ingress-egress","level":"warn","severity":"WARNING","msg":"twilio.webhook.invalid_signature","url":"http://127.0.0.1:57317/webhooks/twilio"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at src/apps/ingress-egress-service.ts:170:20
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at urlencodedParser (node_modules/body-parser/lib/types/urlencoded.js:57:7)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:132:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)
    console.log
      {"ts":"2025-12-30T19:45:19.012Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.shutdown.start","reason":"manual"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.013Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.shutdown.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/__tests__/ingress-egress-routing.test.ts (6.368 s)
  ● Console
    console.log
      {"ts":"2025-12-30T19:45:17.020Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.030Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.031Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.031Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.031Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.033Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.034Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.200Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.204Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"internal.ingress.v1","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.211Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.211Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-khpnxa92","queue":"ingress-egress.proc-khpnxa92"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.212Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.213Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-khpnxa92","queue":"ingress-egress.proc-khpnxa92"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.213Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-khpnxa92","subscription":"internal.egress.v1.proc-khpnxa92.ingress-egress.proc-khpnxa92","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.714Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-1","candidateId":"cand-1","priority":1,"createdAt":"2025-12-30T19:45:17.714Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.716Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-1","source":"ingress.discord","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.717Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-1","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.719Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.719Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.719Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.719Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.719Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-co509rus","queue":"ingress-egress.proc-co509rus"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.720Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-co509rus","queue":"ingress-egress.proc-co509rus"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:17.721Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-co509rus","subscription":"internal.egress.v1.proc-co509rus.ingress-egress.proc-co509rus","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.221Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-3","candidateId":"cand-3","priority":1,"createdAt":"2025-12-30T19:45:18.221Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.221Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-3","source":"command-processor","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.222Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-3","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.222Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.222Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.222Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-t24que3n","queue":"ingress-egress.proc-t24que3n"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.223Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.224Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-t24que3n","queue":"ingress-egress.proc-t24que3n"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.224Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-t24que3n","subscription":"internal.egress.v1.proc-t24que3n.ingress-egress.proc-t24que3n","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.724Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-v1","source":"ingress.discord","isDiscord":true,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.724Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-v1","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.725Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-g801530v","queue":"ingress-egress.proc-g801530v"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-g801530v","queue":"ingress-egress.proc-g801530v"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:18.726Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-g801530v","subscription":"internal.egress.v1.proc-g801530v.ingress-egress.proc-g801530v","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.227Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-2","candidateId":"cand-2","priority":1,"createdAt":"2025-12-30T19:45:19.227Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.227Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-2","source":"ingress.twitch","isDiscord":false,"isTwilio":false}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.227Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-2","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.228Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.228Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.228Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.228Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.228Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"twilio.init_ok"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/webhooks/twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twitch-eventsub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"discord"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"connector.started","name":"twilio"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress_subscribe.start","subject":"internal.egress.v1.proc-92g2ku3g","queue":"ingress-egress.proc-92g2ku3g"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.egress.v1.proc-92g2ku3g","queue":"ingress-egress.proc-92g2ku3g"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.229Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.egress.v1.proc-92g2ku3g","subscription":"internal.egress.v1.proc-92g2ku3g.ingress-egress.proc-92g2ku3g","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.729Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.candidate_selected","correlationId":"corr-twilio","candidateId":"cand-twilio","priority":1,"createdAt":"2025-12-30T19:45:19.729Z"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.729Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.egress.sent","correlationId":"corr-twilio","source":"ingress.twilio","isDiscord":false,"isTwilio":true}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-30T19:45:19.729Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.finalize.published","correlationId":"corr-twilio","status":"SENT"}
      at Logger.info (src/common/logging.ts:142:13)
A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 6 passed, 6 total
Tests:       28 passed, 28 total
Snapshots:   0 total
Time:        7.304 s, estimated 8 s
Ran all test suites matching /src\/services\/ingress\/twilio|src\/apps\/__tests__\/ingress-egress-webhooks.test.ts|src\/apps\/__tests__\/ingress-egress-routing.test.ts/i.
