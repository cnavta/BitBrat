
> bitbrat-platform@1.0.0 test
> jest
(node:51199) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:51205) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/apps/ingress-egress-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:21:59.881Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.902Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.904Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.904Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.905Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.907Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.908Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.910Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/base-server-routing.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:00.058Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.059Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.059Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.059Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.060Z","service":"test-service","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.060Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.061Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.062Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.062Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.063Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.063Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.063Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.063Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.step2.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.064Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.064Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.064Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.064Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.064Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.065Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.065Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.065Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.065Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.066Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.066Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.066Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.066Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.081Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.082Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.082Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.082Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.082Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.083Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.083Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.083Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.083Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.083Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.084Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.084Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.084Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.084Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.085Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.085Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:00.102Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":1,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/llm-bot-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:01.130Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.132Z","service":"llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.133Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.133Z","service":"llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.133Z","service":"llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.133Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.134Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.134Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/llm-bot-service.spec.ts
 PASS  tools/brat/src/orchestration/exec.spec.ts
 PASS  src/apps/command-processor-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:01.868Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.869Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.869Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.869Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.870Z","service":"command-processor","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.870Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.870Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.870Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.871Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:01.871Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/oauth-service.oauth-routes.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.003Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.004Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.005Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.005Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.005Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.006Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/__tests__/base-server-helpers.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.113Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.114Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.114Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.114Z","service":"test","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.114Z","service":"test","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.115Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.115Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/ping"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.115Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/echo"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.121Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.121Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.122Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.122Z","service":"test","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.122Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51198) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  infrastructure/scripts/extract-config.test.ts
 PASS  src/apps/auth-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.382Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.384Z","service":"auth","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.384Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.384Z","service":"auth","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.384Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.385Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51207) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/common/base-server.logger.test.ts (5.345 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.406Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.434Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.434Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.435Z","service":"test-svc","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.435Z","service":"test-svc","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.439Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.442Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.443Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.443Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.443Z","service":"test-svc","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.443Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/command-processor/routing-advance.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.479Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.480Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.480Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.480Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.481Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.481Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.481Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.485Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.published","subject":"dev.internal.egress.v1","stepIndex":1,"attempt":0,"correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.486Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.487Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.487Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.487Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.487Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.487Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.488Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.500Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"dev.internal.egress.v1.dev1","correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.500Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.500Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.501Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.501Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.501Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.501Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.501Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/__tests__/command-processor-service.test.ts (5.721 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:21:59.866Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.902Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.904Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.904Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.906Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.907Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:21:59.907Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:21:59.918Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at exec (src/apps/command-processor-service.ts:41:28)
      at src/apps/command-processor-service.ts:46:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:44:30
      at src/common/base-server.ts:192:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:189:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:11)
    console.error
      {"ts":"2025-12-09T23:22:02.482Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.lookup.error","name":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at findByNameOrAlias (src/services/command-processor/command-repo.ts:101:12)
      at processEvent (src/services/command-processor/processor.ts:146:37)
      at exec (src/apps/command-processor-service.ts:41:22)
      at src/apps/command-processor-service.ts:46:28
      at src/apps/command-processor-service.ts:44:17
      at src/common/base-server.ts:192:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:189:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)
    console.error
      {"ts":"2025-12-09T23:22:02.483Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:74:20
      at src/common/base-server.ts:192:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:189:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)
    console.log
      {"ts":"2025-12-09T23:22:02.484Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.484Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.484Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.484Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.485Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.485Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.485Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:02.486Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at exec (src/apps/command-processor-service.ts:41:28)
      at src/apps/command-processor-service.ts:46:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:44:30
      at src/common/base-server.ts:192:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:189:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:11)
    console.error
      {"ts":"2025-12-09T23:22:02.619Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.lookup.error","name":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at findByNameOrAlias (src/services/command-processor/command-repo.ts:101:12)
      at processEvent (src/services/command-processor/processor.ts:146:37)
      at exec (src/apps/command-processor-service.ts:41:22)
      at src/apps/command-processor-service.ts:46:28
      at src/apps/command-processor-service.ts:44:17
      at src/common/base-server.ts:192:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:189:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)
    console.error
      {"ts":"2025-12-09T23:22:02.619Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:74:20
      at src/common/base-server.ts:192:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:189:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)
(node:51208) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tools/brat/src/cli/__tests__/deploy-substitutions.scaling.test.ts
 PASS  src/apps/oauth-service.test.ts (5.637 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.561Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.579Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.579Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.579Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.580Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.581Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/event-router-service.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.666Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.668Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.668Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.669Z","service":"event-router","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.681Z","service":"event-router","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.682Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.682Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.682Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.682Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.683Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.683Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.683Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.688Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.688Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.689Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.689Z","service":"event-router","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.690Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.690Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.690Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.691Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.691Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.692Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.692Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/__tests__/event-router-debug.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.742Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.743Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.744Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.744Z","service":"event-router","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.744Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.744Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.744Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.745Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.745Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.748Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.749Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.753Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.754Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.755Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.755Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.755Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.758Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/apps/command-processor-error-policy.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.745Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.746Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.746Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.746Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.747Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-09T23:22:02.763Z","service":"command-processor","level":"error","severity":"ERROR","msg":"base_server.message.handler_error","subject":"dev.internal.command.v1","error":"Expected property name or '}' in JSON at position 1 (line 1 column 2)"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at subscriber.subscribe (src/common/base-server.ts:200:25)
      at Object.<anonymous> (tests/apps/command-processor-error-policy.spec.ts:62:5)
(node:51206) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tools/brat/src/cli/trigger.spec.ts
 PASS  src/apps/ingress-egress-service.krevision.test.ts (5.82 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.768Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.805Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.806Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.807Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.807Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.824Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.826Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"auto","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.857Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/common/base-server-get-resource.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.879Z","service":"svc","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/twitch-oauth.test.ts
 PASS  src/types/events.types.test.ts
 PASS  src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.916Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.919Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.919Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.subscription.created","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.919Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.946Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.946Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.946Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/apps/__tests__/event-router-ingress.integration.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.952Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.953Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.954Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.954Z","service":"event-router","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.954Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.955Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.955Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.955Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.955Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.956Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.956Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.958Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51204) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/common/base-server.debug-config.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.933Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.948Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.950Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.950Z","service":"test-svc","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.950Z","service":"test-svc","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.954Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/base-server.test.ts (5.993 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:02.942Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.956Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.957Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.957Z","service":"test-svc","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.957Z","service":"test-svc","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:02.961Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.033Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.033Z","service":"custom","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.033Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.033Z","service":"custom","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.034Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.014Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.014Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.015Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"topic.test","error":"pubsub.topic is not a function"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:60:29)
    console.warn
      {"ts":"2025-12-09T23:22:03.015Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"topic.test","subscription":"topic.test.sub","error":"pubsub.topic is not a function"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:60:19)
    console.log
      {"ts":"2025-12-09T23:22:03.015Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.041Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.041Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.041Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_topic_failed","topic":"topic.test","error":"pubsub.topic is not a function"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureTopic (src/services/message-bus/pubsub-driver.ts:64:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:282:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:86:29)
    console.warn
      {"ts":"2025-12-09T23:22:03.042Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"pubsub.ensure_subscription_failed","topic":"topic.test","subscription":"topic.test.sub","error":"pubsub.topic is not a function"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at ensureSubscription (src/services/message-bus/pubsub-driver.ts:418:12)
      at PubSubSubscriber.subscribe (src/services/message-bus/pubsub-driver.ts:283:13)
      at Object.<anonymous> (src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts:86:19)
    console.log
      {"ts":"2025-12-09T23:22:03.042Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/base-server-step-update.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.072Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.073Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.073Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.074Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.074Z","service":"test-service","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.074Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.075Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.075Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.075Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.075Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.075Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.076Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.076Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.076Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.077Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.077Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.077Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.077Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.078Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.078Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.078Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.079Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.079Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.079Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.079Z","service":"test-service","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.079Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/base-server-onmessage.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.081Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.082Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.082Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.082Z","service":"test","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.082Z","service":"test","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.083Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.083Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.test.json","queue":"test"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.084Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.test.json","queue":"test"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/command-processor/policy-global-cooldown.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.103Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"GLOBAL_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:01.000Z","remainingMs":6000}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/common/base-server-resources.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.120Z","service":"test-svc","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/common/firebase.test.ts
 PASS  tests/services/command-processor/policy-user-cooldown.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.189Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"USER_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:02.000Z","remainingMs":7000,"userId":"u-1"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/ingress/twitch/credentials-provider.spec.ts
 PASS  tests/services/command-processor/processor.spec.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.173Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:30:35)
    console.log
      {"ts":"2025-12-09T23:22:03.184Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.184Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"ping","id":"cmd1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.184Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.185Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.188Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:56:35)
    console.log
      {"ts":"2025-12-09T23:22:03.188Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"note","args":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.189Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"note","id":"cmdA"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.189Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.effect.added","effect":"annotation","name":"note","kind":"prompt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.191Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:79:35)
    console.log
      {"ts":"2025-12-09T23:22:03.191Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"cool","args":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.191Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"cool","id":"cmd3"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.193Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:99:35)
    console.log
      {"ts":"2025-12-09T23:22:03.193Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"missing","args":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.193Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.not_found","name":"missing"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.194Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:118:35)
    console.log
      {"ts":"2025-12-09T23:22:03.194Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"rate","args":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.194Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"rate","id":"cmd2"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.195Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:141:35)
    console.log
      {"ts":"2025-12-09T23:22:03.195Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.sigil_optional.matched","name":"hello"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.195Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"hello","id":"cmd4"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.195Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.195Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.196Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:163:35)
 PASS  src/services/ingress/twitch/publisher.spec.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.207Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":1,"code":14}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)
    console.warn
      {"ts":"2025-12-09T23:22:03.228Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":2,"code":14}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)
    console.warn
      {"ts":"2025-12-09T23:22:03.233Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.no_retry_on_timeout","subject":"dev.internal.ingress.v1","attempt":1,"code":4,"reason":"publish_timeout"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:67:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:102:5)
 PASS  tests/services/command-processor/command-repo.spec.ts
 PASS  tests/services/command-processor/policy-rate-limit.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.272Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"RATE_LIMIT","rate":{"max":2,"perMs":60000},"windowKey":"20***0000","count":2}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/message-bus/nats-driver.test.ts
 PASS  src/services/message-bus/__tests__/pubsub-publisher-logging.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.292Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.294Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.295Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.295Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"on-publish-fail","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/command-processor/logging.spec.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.293Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/services/command-processor/logging.spec.ts:31:35)
 PASS  tests/services/command-processor/parsing.spec.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.317Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:24:34)
    console.warn
      {"ts":"2025-12-09T23:22:03.318Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:31:34)
    console.log
      {"ts":"2025-12-09T23:22:03.318Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":2}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/integration/command-processor-smoke.spec.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.339Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:80:12)
      at processEvent (src/services/command-processor/processor.ts:118:21)
      at Object.<anonymous> (tests/integration/command-processor-smoke.spec.ts:31:39)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"hello","args":1}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"hello","id":"cmd-hello"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51203) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/llm-bot/processor.memory.spec.ts (6.251 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.140Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.164Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.166Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.166Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.166Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.199Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.315Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.316Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.316Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.316Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.316Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.333Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.333Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.333Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.333Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.333Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/services/command-processor/template-render.spec.ts
 PASS  src/common/__tests__/logging-trace-correlation.spec.ts
 PASS  src/common/logging.test.ts
 PASS  tests/services/message-bus/pubsub-batching.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.365Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.367Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"internal.test.v1","batching":{"maxMessages":100,"maxMilliseconds":1500},"ensureMode":"on-publish-fail","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  src/services/ingress/twitch/credentials-provider.config.spec.ts
 PASS  src/services/llm-bot/processor.openai.spec.ts (6.338 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.325Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.340Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.341Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.360Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tests/common/publisher-manager.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.409Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.411Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.412Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"publisher.manager.flush.error","error":"boom"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.flushAll (src/common/resources/publisher-manager.ts:33:15)
      at Object.<anonymous> (tests/common/publisher-manager.spec.ts:40:5)
    console.log
      {"ts":"2025-12-09T23:22:03.412Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51201) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/ingress/twitch/__tests__/twurple-integration.spec.ts
 PASS  src/services/llm-bot/processor.test.ts (6.399 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.371Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.388Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.389Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.389Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.389Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.390Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.418Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.no_prompt_annotations","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.422Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.422Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.422Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.422Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.423Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51202) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  src/services/router/__tests__/rule-loader.hardening.test.ts
  ● Console
    console.error
      {"ts":"2025-12-09T23:22:03.453Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.warm_load_error","error":"emulator not available"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:106:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:12:5)
    console.error
      {"ts":"2025-12-09T23:22:03.456Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.subscribe_error","error":"listen failed"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:120:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:26:5)
 PASS  src/services/router/__tests__/rule-loader.test.ts
  ● Console
    console.warn
      {"ts":"2025-12-09T23:22:03.455Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"d"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:133:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:103:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)
    console.warn
      {"ts":"2025-12-09T23:22:03.456Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"e"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:133:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:103:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)
 PASS  tests/services/command-processor/template-selection.spec.ts
 PASS  src/services/routing/__tests__/router-engine.test.ts
 PASS  src/common/config.test.ts
 PASS  src/services/twitch-token-manager.test.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.503Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch_token_manager.refreshed"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-09T23:22:03.506Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twitch_token_manager.refresh_failed","status":400,"body":"bad"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at doRefresh (src/services/twitch-token-manager.ts:84:18)
      at TwitchTokenManager.getValidToken (src/services/twitch-token-manager.ts:42:12)
      at TwitchTokenManager.getValidAccessToken (src/services/twitch-token-manager.ts:22:19)
      at Object.<anonymous> (src/services/twitch-token-manager.test.ts:64:17)
 PASS  tools/brat/src/providers/cdktf-synth.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tools/brat/src/config/loader.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tools/brat/src/providers/cdktf-synth.lb.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  src/services/ingress/twitch/twitch-irc-client.spec.ts
 PASS  tests/common/firestore-manager.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.527Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.531Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.531Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
 PASS  tools/brat/src/lb/importer/__tests__/importer.test.ts
 PASS  tests/services/message-bus/nats-flush.spec.ts
 PASS  tools/brat/src/lb/importer/__tests__/importer.guard.test.ts
 PASS  tests/services/message-bus/nats-attributes.spec.ts
 PASS  tests/services/message-bus/subscriber-dedupe.spec.ts
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.557Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.560Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.test.v1","subscription":"internal.test.v1.q","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.560Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.test.v1.q"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-09T23:22:03.562Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"message_consumer.dedupe.drop","driver":"pubsub","subscription":"internal.test.v1.q","idempotencyKey":"***","ttlMs":60000}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at SubscriptionMock.onMessage (src/services/message-bus/pubsub-driver.ts:338:22)
      at Object.<anonymous> (tests/services/message-bus/subscriber-dedupe.spec.ts:54:22)
 PASS  tools/brat/src/config/__tests__/interpolation.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["ENV","NOPE"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":["UNKNOWN_VAR"],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tools/brat/src/config/schema.routing.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.buckets.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tools/brat/src/providers/gcp/preflight.spec.ts
  ● Console
    console.warn
      [preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.
      22 |     }
      23 |     // Local override: permit skipping checks for development
    > 24 |     console.warn('[preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.');
         |             ^
      25 |     return;
      26 |   }
      27 |
      at assertVpcPreconditions (tools/brat/src/providers/gcp/preflight.ts:24:13)
      at Object.<anonymous> (tools/brat/src/providers/gcp/preflight.spec.ts:32:40)
 PASS  tools/brat/src/lb/urlmap/__tests__/renderer.routing.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.example.com default_bucket=site-assets selected_default_backend=be-assets-proxy
      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)
 PASS  src/services/router/__tests__/jsonlogic-evaluator.test.ts
 PASS  src/common/retry.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.network.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tools/brat/src/providers/cdktf-synth.connectors.spec.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  src/services/llm-bot/processor.empty-response.spec.ts (6.644 s)
  ● Console
    console.log
      {"ts":"2025-12-09T23:22:03.532Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.549Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.550Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.550Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.551Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.552Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.592Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.622Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.623Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.623Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.625Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.625Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-09T23:22:03.633Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}
      at Logger.info (src/common/logging.ts:142:13)
(node:51200) Warning: The 'NO_COLOR' env is ignored due to the 'FORCE_COLOR' env being set.
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  tools/brat/src/providers/cdktf-synth.loadbalancer.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  src/services/message-bus/__tests__/subscriber-options.test.ts
 PASS  tools/brat/src/config/schema.spec.ts
 PASS  tools/brat/src/config/__tests__/allow-unauth.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  infrastructure/cdktf/network/config.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/from-repo-arch.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.bitbrat.ai default_bucket=default-content-bucket selected_default_backend=be-assets-proxy
      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)
 PASS  tools/brat/src/config/schema.test.ts
 PASS  tools/brat/src/providers/cdktf-synth.loadbalancer.routing.test.ts
  ● Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
 PASS  tests/services/message-bus/pubsub-logging.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/renderer.test.ts
 PASS  tools/brat/src/providers/gcp/secrets.spec.ts
 PASS  src/services/message-bus/message-bus.test.ts
 PASS  infrastructure/scripts/bootstrap-service.test.js
 PASS  tools/brat/src/providers/gcp/cloudbuild-triggers.spec.ts
 PASS  tools/brat/src/config/__tests__/resolve-services.scaling.test.ts
 PASS  src/services/ingress/twitch/envelope-builder.spec.ts
 PASS  tools/brat/src/providers/gcp/cloudbuild.spec.ts
 PASS  tests/services/message-bus/nats-logging.spec.ts
 PASS  tools/brat/src/lb/urlmap/__tests__/load-from-arch.test.ts
 PASS  tests/services/command-processor/candidate-create.spec.ts
 PASS  tools/brat/src/providers/gcp/lb-preflight.spec.ts
 PASS  src/common/feature-flags.test.ts
 PASS  src/services/message-bus/__tests__/factory-selection.test.ts
 PASS  tests/services/message-bus/normalize-attributes.spec.ts
 PASS  tests/services/egress/selection.test.ts
 PASS  tests/common/retry.spec.ts
 PASS  tools/brat/src/providers/gcp/apis.spec.ts
 PASS  tools/brat/src/config/schema.network.spec.ts
 PASS  tests/services/message-bus/pubsub-attributes.spec.ts
 PASS  tests/common/events/attributes.spec.ts
 PASS  src/services/routing/routing.dlq.test.ts
 PASS  tools/brat/src/providers/gcp/cloudrun.spec.ts
 PASS  src/services/auth/__tests__/enrichment.spec.ts
 PASS  tools/brat/src/orchestration/errors.spec.ts
 PASS  src/services/routing/routing.slip.test.ts
Test Suites: 1 skipped, 115 passed, 115 of 116 total
Tests:       2 skipped, 300 passed, 302 total
Snapshots:   2 passed, 2 total
Time:        7.45 s
Ran all test suites.
