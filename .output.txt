[validate_deliverable] Notice: PROJECT_ID not provided. Will run install/build/tests only and skip infra + deployment steps.
üîß Installing dependencies...
up to date, audited 806 packages in 1s
143 packages are looking for funding
  run `npm fund` for details
4 vulnerabilities (2 moderate, 2 high)
To address all issues, run:
  npm audit fix
Run `npm audit` for details.
üß± Compiling...
> bitbrat-platform@1.0.0 build
> tsc -p tsconfig.json
üß™ Running tests (scope=all)...
> bitbrat-platform@1.0.0 test
> jest
PASS src/services/routing/__tests__/router-engine-annotations.spec.ts
PASS src/services/router/__tests__/rule-loader-annotations.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:33.294Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.annotation_invalid","ruleId":"r-1"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at sanitizeAnnotations (src/services/router/rule-loader.ts:68:14)
      at validateRule (src/services/router/rule-loader.ts:97:23)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:185:20)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader-annotations.spec.ts:24:21)
PASS src/apps/llm-bot-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:33.802Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:33.806Z","service":"llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:33.806Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:33.817Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:33.817Z","service":"llm-bot","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.llmbot.v1","queue":"llm-bot"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/__tests__/command-processor-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:34.048Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.049Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.049Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.049Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.050Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.152Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:34.152Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:34.187Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at exec (src/apps/command-processor-service.ts:66:28)
      at src/apps/command-processor-service.ts:71:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:69:30
      at src/common/base-server.ts:235:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:232:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:11)
    console.error
      {"ts":"2025-12-12T01:44:35.453Z","service":"command-processor","level":"error","severity":"ERROR","msg":"regex_cache.snapshot.error","error":"Error 7: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at QueryWatch.onError (src/services/command-processor/regex-cache.ts:147:14)
      at QueryWatch.closeStream (node_modules/@google-cloud/firestore/build/src/watch.js:227:18)
      at QueryWatch.onData (node_modules/@google-cloud/firestore/build/src/watch.js:376:22)
      at PassThrough.<anonymous> (node_modules/@google-cloud/firestore/build/src/watch.js:322:26)
      at StreamProxy.ondata (node_modules/readable-stream/lib/_stream_readable.js:629:20)
      at addChunk (node_modules/readable-stream/lib/_stream_readable.js:279:12)
      at readableAddChunk (node_modules/readable-stream/lib/_stream_readable.js:262:11)
      at StreamProxy.Object.<anonymous>.Readable.push (node_modules/readable-stream/lib/_stream_readable.js:228:10)
      at StreamProxy.Object.<anonymous>.Duplexify._forward (node_modules/duplexify/index.js:172:26)
      at ClientDuplexStreamImpl.onreadable (node_modules/duplexify/index.js:136:10)
    console.error
      {"ts":"2025-12-12T01:44:35.490Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.findFirstByCommandTerm.error","term":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at findFirstByCommandTerm (src/services/command-processor/command-repo.ts:137:12)
      at processEvent (src/services/command-processor/processor.ts:175:9)
      at exec (src/apps/command-processor-service.ts:66:22)
      at src/apps/command-processor-service.ts:71:28
      at src/apps/command-processor-service.ts:69:17
      at src/common/base-server.ts:235:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:232:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)
    console.error
      {"ts":"2025-12-12T01:44:35.490Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:99:20
      at src/common/base-server.ts:235:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:232:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:63:5)
    console.log
      {"ts":"2025-12-12T01:44:35.491Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.491Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.491Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.491Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.491Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.492Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:35.492Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:35.492Z","service":"command-processor","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at exec (src/apps/command-processor-service.ts:66:28)
      at src/apps/command-processor-service.ts:71:34
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at src/apps/command-processor-service.ts:69:30
      at src/common/base-server.ts:235:39
      at src/common/tracing.ts:104:20
      at NoopContextManager.with (node_modules/@opentelemetry/api/src/context/NoopContextManager.ts:31:15)
      at ContextAPI.with (node_modules/@opentelemetry/api/src/api/context.ts:77:42)
      at NoopTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/NoopTracer.ts:98:27)
      at ProxyTracer.startActiveSpan (node_modules/@opentelemetry/api/src/trace/ProxyTracer.ts:51:20)
      at startActiveSpan (src/common/tracing.ts:102:17)
      at subscriber.subscribe (src/common/base-server.ts:232:36)
      at capturedHandler (src/apps/__tests__/command-processor-service.test.ts:12:13)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:11)
    console.error
      {"ts":"2025-12-12T01:44:36.109Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_repo.findFirstByCommandTerm.error","term":"ping","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at findFirstByCommandTerm (src/services/command-processor/command-repo.ts:137:12)
      at processEvent (src/services/command-processor/processor.ts:175:9)
      at exec (src/apps/command-processor-service.ts:66:22)
      at src/apps/command-processor-service.ts:71:28
      at src/apps/command-processor-service.ts:69:17
      at src/common/base-server.ts:235:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:232:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)
    console.error
      {"ts":"2025-12-12T01:44:36.109Z","service":"command-processor","level":"error","severity":"ERROR","msg":"command_processor.process_error","subject":"dev.internal.command.v1","error":"7 PERMISSION_DENIED: Missing or insufficient permissions."}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at src/apps/command-processor-service.ts:99:20
      at src/common/base-server.ts:235:17
      at src/common/tracing.ts:104:14
      at subscriber.subscribe (src/common/base-server.ts:232:15)
      at Object.<anonymous> (src/apps/__tests__/command-processor-service.test.ts:88:5)
PASS tests/services/command-processor/routing-advance.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:36.330Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.331Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.331Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.331Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.332Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.354Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.355Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.392Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.published","subject":"dev.internal.egress.v1","stepIndex":1,"attempt":0,"correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.394Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"dev.internal.egress.v1.dev1","correlationId":"c-adv-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/__tests__/processor.personality-mixed.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:36.485Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.487Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.487Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:36.497Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.composed","count":2,"names":["p2"],"versions":[9],"mode":"append","metrics":{"resolved":2,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":1,"clamped":0},"preview":"BASE\n\nINLINE\n\nDBTEXT2","correlationId":"c-pers-mixed"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/routing/__tests__/router-engine-ops-integration.spec.ts
PASS src/services/router/__tests__/jsonlogic-ci-eq.spec.ts
PASS src/services/router/__tests__/jsonlogic-slip-complete.spec.ts
PASS src/services/router/__tests__/jsonlogic-extra-ops.spec.ts
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/services/command-processor/routing-advance.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
PASS src/services/router/__tests__/jsonlogic-re-test.spec.ts
PASS src/services/llm-bot/processor.memory.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:37.209Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.209Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.210Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.215Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.215Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.215Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.219Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.219Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.219Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/apps/command-processor-error-policy.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:37.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher","firestore"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.396Z","service":"command-processor","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.397Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"fi***tore"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.397Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.398Z","service":"command-processor","level":"info","severity":"INFO","msg":"regex_cache.start"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.413Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.regex_cache.started"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.413Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.413Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.413Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"dev.internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-12T01:44:37.435Z","service":"command-processor","level":"error","severity":"ERROR","msg":"base_server.message.handler_error","subject":"dev.internal.command.v1","error":"Expected property name or '}' in JSON at position 1 (line 1 column 2)"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at subscriber.subscribe (src/common/base-server.ts:243:25)
      at Object.<anonymous> (tests/apps/command-processor-error-policy.spec.ts:62:5)
PASS src/services/llm-bot/processor.error.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:37.529Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.530Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.531Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-12T01:44:37.534Z","service":"test-llm-bot","level":"error","severity":"ERROR","msg":"openai.error","correlationId":"c-error","model":"gpt-5-mini","durationMs":0,"message":"boom","name":"Error"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at RunnableCallable.func (src/services/llm-bot/processor.ts:347:28)
    console.error
      {"ts":"2025-12-12T01:44:37.535Z","service":"test-llm-bot","level":"error","severity":"ERROR","msg":"llm_bot.error","message":"boom","correlationId":"c-error","err":{"pregelTaskId":"4f47ee41-bdd0-58a1-a971-9905cc4b1f5c"}}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at processEvent (src/services/llm-bot/processor.ts:401:12)
      at Object.<anonymous> (src/services/llm-bot/processor.error.spec.ts:25:20)
PASS src/common/base-server.debug-config.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:37.708Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.709Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:37.709Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From tests/apps/command-processor-error-policy.spec.ts.
      at Firestore.get (node_modules/@google-cloud/firestore/build/src/index.js:1540:16)
      at ClientPool.clientFactory (node_modules/@google-cloud/firestore/build/src/index.js:526:45)
      at ClientPool.acquire (node_modules/@google-cloud/firestore/build/src/pool.js:121:35)
      at ClientPool.run (node_modules/@google-cloud/firestore/build/src/pool.js:260:29)
      at node_modules/@google-cloud/firestore/build/src/index.js:1412:30
      at Firestore._retry (node_modules/@google-cloud/firestore/build/src/index.js:1270:30)
PASS src/apps/ingress-egress-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.024Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"noop","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.025Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.026Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/ingress-egress-service.krevision.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.266Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.266Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.266Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.267Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"ingress-egress.config","messageBusDriver":"noop","pubsub":{"batchMaxMs":"(default: 20)","batchMaxMessages":"(default: 100)","publishTimeoutMs":"(auto: 2000 in Cloud Run, 0 locally)","ensureMode":"(default: on-publish-fail)"}}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.279Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.282Z","service":"ingress-egress","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/twitch"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/processor.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.377Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.378Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.379Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.382Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.no_prompt_annotations","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.383Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.383Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.383Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/processor.empty-response.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.475Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.476Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.476Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.481Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.482Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.482Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.482Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.484Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.empty_llm_response","correlationId":"c-empty"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/auth-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.693Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.693Z","service":"auth","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.693Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.693Z","service":"auth","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/__tests__/processor.personality-name.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.772Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.773Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.773Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.781Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.composed","count":1,"names":["p1"],"versions":[7],"mode":"append","metrics":{"resolved":1,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":1,"clamped":0},"preview":"BASE\n\nDBTEXT","correlationId":"c-pers-name"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/processor.personality.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:38.862Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.862Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.862Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:38.865Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"llm_bot.personality.composed","count":1,"names":[],"versions":[],"mode":"append","metrics":{"resolved":1,"failed":0,"dropped":0,"cacheHit":0,"cacheMiss":0,"clamped":0},"preview":"BASE\n\nPERS","correlationId":"c-pers"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/llm-bot-service.spec.ts
PASS src/services/llm-bot/reducer.spec.ts
PASS src/services/llm-bot/processor.openai.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:39.197Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.197Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.198Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.debug
      openai.request.raw {"model":"gpt-5-mini","input":"(user) hello\n\n(user) Say hi","max_output_tokens":1024}
      at callOpenAI (src/services/llm-bot/processor.ts:108:11)
    console.debug
      openai.response.raw {"output_text":"Hello world"}
      at callOpenAI (src/services/llm-bot/processor.ts:114:11)
PASS src/apps/oauth-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:39.434Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.434Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.434Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.435Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"Initializing Firestore","databaseId":"twitch"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/command-processor-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:39.615Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.regex_cache.skipped_in_tests"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.616Z","service":"command-processor","level":"info","severity":"INFO","msg":"command_processor.subscribe.ok","subject":"internal.command.v1","queue":"command-processor"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/processor.personality-disabled.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:39.710Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.711Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:39.711Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tools/brat/src/orchestration/exec.spec.ts
PASS src/common/base-server.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.062Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.062Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.062Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.079Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.079Z","service":"custom","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.080Z","service":"custom","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/oauth-service.oauth-routes.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.254Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.254Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.254Z","service":"oauth-flow","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/apps/__tests__/event-router-debug.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.444Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.445Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.445Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.445Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.446Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.446Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.446Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.448Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.452Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.456Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.456Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.456Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.456Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.456Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.457Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.457Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.457Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.457Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.462Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/processor.instance-memory.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.552Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.553Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.553Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.565Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.565Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.565Z","service":"test-llm-bot","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/common/__tests__/base-server-helpers.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.735Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.735Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.735Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.735Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/ping"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.736Z","service":"test","level":"info","severity":"INFO","msg":"base_server.http.register","method":"POST","path":"/echo"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.746Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.746Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.746Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/base-server-onmessage.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:40.905Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.906Z","service":"test","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.906Z","service":"test","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.906Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"internal.test.json","queue":"test"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:40.906Z","service":"test","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"internal.test.json","queue":"test"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/base-server-step-update.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:41.065Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.066Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.066Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.067Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.067Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.067Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.068Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.068Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.068Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.069Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.069Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.069Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.069Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.070Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.070Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/common/base-server-resources.spec.ts
PASS src/types/events.types.test.ts
PASS src/apps/event-router-service.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:41.604Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.604Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.604Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.604Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.604Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.605Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.605Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.605Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.605Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.606Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.607Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.607Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"test.internal.custom.topic.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/common/base-server-get-resource.spec.ts
PASS tests/base-server-routing.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:41.943Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.944Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.944Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.944Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.945Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.945Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.945Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.945Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.step2.v1","stepIndex":1,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.946Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.946Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.946Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.947Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.fallback_egress","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.947Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.947Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.947Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.947Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.948Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.948Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.948Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.948Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.complete.published","dest":"internal.egress.v1","correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.949Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.949Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.949Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.949Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":0,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.950Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.950Z","service":"test-service","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.950Z","service":"test-service","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:41.961Z","service":"test-service","level":"info","severity":"INFO","msg":"routing.next.published","subject":"internal.bot.requests.v1","stepIndex":0,"attempt":1,"correlationId":"c-1"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/command-processor/processor.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:42.128Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:30:35)
    console.log
      {"ts":"2025-12-12T01:44:42.129Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.129Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"ping","id":"cmd1","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.129Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.129Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"ping","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:42.130Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:56:35)
    console.log
      {"ts":"2025-12-12T01:44:42.130Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"note","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.130Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"note","id":"cmdA","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.130Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.effect.added","effect":"annotation","name":"note","kind":"prompt"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:42.131Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:79:35)
    console.log
      {"ts":"2025-12-12T01:44:42.131Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"cool","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.131Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"cool","id":"cmd3","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:42.132Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:99:35)
    console.log
      {"ts":"2025-12-12T01:44:42.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"missing","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:42.132Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:118:35)
    console.log
      {"ts":"2025-12-12T01:44:42.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"rate","args":0,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:42.132Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"rate","id":"cmd2","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:42.133Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/processor.spec.ts:147:35)
PASS tools/brat/src/cli/trigger.spec.ts
PASS tests/services/command-processor/parsing.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:42.753Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:24:34)
    console.warn
      {"ts":"2025-12-12T01:44:42.754Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at Object.<anonymous> (tests/services/command-processor/parsing.spec.ts:33:34)
    console.log
      {"ts":"2025-12-12T01:44:42.754Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"ping","args":2,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tools/brat/src/cli/__tests__/deploy-substitutions.scaling.test.ts
PASS infrastructure/scripts/extract-config.test.ts
PASS src/common/base-server.logger.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:43.226Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:43.226Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:43.227Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:43.228Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:43.228Z","service":"test-svc","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:43.228Z","service":"test-svc","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/command-processor/policy-rate-limit.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:43.382Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"RATE_LIMIT","rate":{"max":2,"perMs":60000},"windowKey":"20***0000","count":2}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/common/firebase.test.ts
PASS src/services/ingress/twitch/credentials-provider.spec.ts
PASS src/services/twitch-oauth.test.ts
PASS src/services/routing/__tests__/router-engine.test.ts
PASS src/services/message-bus/__tests__/pubsub-subscriber-logging.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:44.086Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.087Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.087Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.101Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.101Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"topic.test","subscription":"topic.test.sub","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.101Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"topic.test.sub"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/message-bus/nats-driver.test.ts
  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-12T01:44:44.311Z","service":"command-processor","level":"error","severity":"ERROR","msg":"regex_cache.snapshot.error","error":"module.exports.v1 is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at QueryWatch.onError (src/services/command-processor/regex-cache.ts:147:14)
      at QueryWatch.closeStream (node_modules/@google-cloud/firestore/build/src/watch.js:227:18)
      at node_modules/@google-cloud/firestore/build/src/watch.js:342:18
PASS src/services/ingress/twitch/credentials-provider.config.spec.ts
PASS src/services/twitch-token-manager.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:44.462Z","service":"bitbrat","level":"info","severity":"INFO","msg":"twitch_token_manager.refreshed"}
      at Logger.info (src/common/logging.ts:142:13)
    console.error
      {"ts":"2025-12-12T01:44:44.466Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"twitch_token_manager.refresh_failed","status":400,"body":"bad"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at doRefresh (src/services/twitch-token-manager.ts:84:18)
      at TwitchTokenManager.getValidToken (src/services/twitch-token-manager.ts:42:12)
      at TwitchTokenManager.getValidAccessToken (src/services/twitch-token-manager.ts:22:19)
      at Object.<anonymous> (src/services/twitch-token-manager.test.ts:64:17)
PASS src/services/message-bus/__tests__/pubsub-subscriber.ensure.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:44.497Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.497Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.497Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.subscription.created","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.497Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.515Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.515Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.ingress.v1","subscription":"internal.ingress.v1.router","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:44.515Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.ingress.v1.router"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/ingress/twitch/twitch-irc-client.spec.ts
PASS tests/services/command-processor/policy-global-cooldown.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:44.801Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"GLOBAL_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:01.000Z","remainingMs":6000}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/command-processor/template-render.spec.ts
PASS tools/brat/src/lb/urlmap/__tests__/renderer.test.ts
PASS tests/services/command-processor/logging.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:45.097Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/services/command-processor/logging.spec.ts:31:35)
PASS tests/services/command-processor/command-repo.spec.ts
PASS src/apps/__tests__/event-router-ingress.integration.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:45.388Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resources.init","keys":["publisher"]}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.388Z","service":"event-router","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.resource.setup.ok","key":"pu***sher"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug/counters"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.http.register","method":"GET","path":"/_debug"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.start","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"base_server.message.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.389Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.subscribe.ok","subject":"dev.internal.user.enriched.v1","queue":"event-router"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.391Z","service":"event-router","level":"info","severity":"INFO","msg":"event_router.publish.ok","subject":"dev.internal.router.dlq.v1","selectedTopic":"internal.router.dlq.v1"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/common/firestore-manager.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:45.421Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.422Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.422Z","service":"bitbrat","level":"info","severity":"INFO","msg":"firestore.manager.setup.reuse"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/command-processor/template-selection.spec.ts
PASS tests/services/command-processor/policy-user-cooldown.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:45.701Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.policy.blocked","code":"USER_COOLDOWN","cooldownMs":15000,"lastExecutionAt":"2025-01-01T00:00:02.000Z","remainingMs":7000,"userId":"u-1"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/integration/command-processor-smoke.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:45.846Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"command_processor.config.bot_username.missing"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at processForParsing (src/services/command-processor/processor.ts:118:12)
      at processEvent (src/services/command-processor/processor.ts:165:21)
      at Object.<anonymous> (tests/integration/command-processor-smoke.spec.ts:31:39)
    console.log
      {"ts":"2025-12-12T01:44:45.847Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.parsed","name":"hello","args":1,"sigil":"!"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.847Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.command.matched","name":"hello","id":"cmd-hello","kind":"command"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.847Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.template.chosen","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.847Z","service":"bitbrat","level":"info","severity":"INFO","msg":"command_processor.candidate.added","name":"hello","templateId":"t1"}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/message-bus/subscriber-dedupe.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:45.876Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.877Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.start","driver":"pubsub","topic":"internal.test.v1","subscription":"internal.test.v1.q","ackDeadline":60}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:45.877Z","service":"bitbrat","level":"info","severity":"INFO","msg":"message_consumer.subscribe.ready","driver":"pubsub","subscription":"internal.test.v1.q"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:45.877Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"message_consumer.dedupe.drop","driver":"pubsub","subscription":"internal.test.v1.q","idempotencyKey":"***","ttlMs":60000}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at SubscriptionMock.onMessage (src/services/message-bus/pubsub-driver.ts:338:22)
      at Object.<anonymous> (tests/services/message-bus/subscriber-dedupe.spec.ts:54:22)
FAIL tools/brat/src/providers/cdktf-synth.network.spec.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
  ‚óè cdktf synth network module ‚Ä∫ honors overlays: multi-region subnets and flow logs enabled with optional remote backend
    expect(received).toContain(expected) // indexOf
    Expected substring: "backend \"gcs\""
    Received string:    "# Synthesized by brat CDKTF synth (module: network)
    # This file was generated to provision the BitBrat Network using overlays.
    # module: network¬∑
    terraform {
      required_version = \">= 1.5.0\"
      required_providers {
        google = {
          source  = \"hashicorp/google\"
          version = \">= 5.0.0\"
        }
      }
    }¬∑
    provider \"google\" {
      project = var.project_id
      region  = var.region
    }¬∑
    variable \"project_id\" {
      type    = string
      default = \"proj-123\"
    }¬∑
    variable \"region\" {
      type    = string
      default = \"us-central1\"
    }¬∑
    variable \"environment\" {
      type    = string
      default = \"dev\"
    }¬∑
    locals {
      regions = [\"us-central1\", \"us-west1\"]
      subnets = {
        \"us-central1\" = { name = \"brat-subnet-us-central1-dev\", cidr = \"10.10.0.0/20\" },
        \"us-west1\" = { name = \"west-subnet\", cidr = \"10.20.0.0/20\" }
      }
    }¬∑
    # VPC
    resource \"google_compute_network\" \"vpc\" {
      name                    = \"brat-vpc\"
      auto_create_subnetworks = false
    }¬∑
    # Subnets with Private Google Access (per region)
    resource \"google_compute_subnetwork\" \"subnet\" {
      for_each                 = local.subnets
      name                     = each.value.name
      ip_cidr_range            = each.value.cidr
      region                   = each.key
      network                  = google_compute_network.vpc.id
      private_ip_google_access = true¬∑
      log_config {
        aggregation_interval = \"INTERVAL_5_MIN\"
        flow_sampling        = 0.5
        metadata             = \"INCLUDE_ALL\"
      }
    }¬∑
    # Cloud Routers (per region)
    resource \"google_compute_router\" \"router\" {
      for_each = toset(local.regions)
      name     = \"brat-router-${each.key}\"
      region   = each.key
      network  = google_compute_network.vpc.id
    }¬∑
    ## Cloud NAT removed to reduce latency. Public egress should use Cloud Run default path.
    ## When using Serverless VPC Access, set egress to \"Private ranges only\" so public
    ## traffic (e.g., Pub/Sub APIs) bypasses the connector.¬∑
    # Firewall: allow-internal
    resource \"google_compute_firewall\" \"allow_internal\" {
      name    = \"allow-internal\"
      network = google_compute_network.vpc.name
      allow {
        protocol = \"icmp\"
      }
      allow {
        protocol = \"tcp\"
        ports    = [\"0-65535\"]
      }
      allow {
        protocol = \"udp\"
        ports    = [\"0-65535\"]
      }
      source_ranges = [
        \"10.0.0.0/8\",
        \"172.16.0.0/12\",
        \"192.168.0.0/16\",
      ]
    }¬∑
    # Firewall: allow-health-checks
    resource \"google_compute_firewall\" \"allow_health_checks\" {
      name    = \"allow-health-checks\"
      network = google_compute_network.vpc.name
      allow {
        protocol = \"tcp\"
        ports    = [\"80\", \"443\"]
      }
      source_ranges = [
        \"35.191.0.0/16\",
        \"130.211.0.0/22\",
      ]
    }¬∑
    # Outputs for downstream stacks
    output \"vpcSelfLink\" {
      description = \"Self link for the created VPC\"
      value       = google_compute_network.vpc.self_link
    }¬∑
    output \"subnetSelfLinkByRegion\" {
      description = \"Map of region to subnet selfLink\"
      value       = { for r, s in google_compute_subnetwork.subnet : r => s.self_link }
    }¬∑
    output \"routersByRegion\" {
      description = \"Map of region to router name\"
      value       = { for r, s in google_compute_router.router : r => s.name }
    }¬∑
    ## NAT outputs removed
    "
      57 |
      58 |     // backend block from remoteState (CI not set in test)
    > 59 |     expect(mainTf).toContain('backend "gcs"');
         |                    ^
      60 |     expect(mainTf).toContain('bucket = "tf-state-bucket"');
      61 |     expect(mainTf).toContain('prefix = "network/dev"');
      62 |
      at Object.<anonymous> (tools/brat/src/providers/cdktf-synth.network.spec.ts:59:20)
PASS src/common/logging.test.ts
PASS src/services/router/__tests__/rule-loader.test.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:46.185Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"d"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:188:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:158:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)
    console.warn
      {"ts":"2025-12-12T01:44:46.185Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"rule_loader.invalid_doc","id":"e"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at RuleLoader.refreshFromSnapshot (src/services/router/rule-loader.ts:188:16)
      at RuleLoader.start (src/services/router/rule-loader.ts:158:12)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.test.ts:35:5)
PASS tests/services/message-bus/nats-flush.spec.ts
PASS tools/brat/src/config/__tests__/interpolation.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["ENV","NOPE"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":["UNKNOWN_VAR"],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS src/common/feature-flags.test.ts
PASS src/common/__tests__/logging-trace-correlation.spec.ts
PASS infrastructure/scripts/bootstrap-service.test.js
PASS src/services/ingress/twitch/__tests__/twurple-integration.spec.ts
PASS tools/brat/src/lb/urlmap/__tests__/renderer.routing.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.example.com default_bucket=site-assets selected_default_backend=be-assets-proxy
      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)
PASS src/services/llm-bot/__tests__/personality-metrics.spec.ts
PASS tools/brat/src/providers/cdktf-synth.loadbalancer.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS tools/brat/src/lb/urlmap/__tests__/from-repo-arch.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      [urlmap.renderer] Using routing-only source. default_domain=api.bitbrat.ai default_bucket=default-content-bucket selected_default_backend=be-assets-proxy
      at loadRendererInputFromArchitecture (tools/brat/src/lb/urlmap/renderer.ts:42:11)
PASS src/services/ingress/twitch/publisher.spec.ts
  ‚óè Console
    console.warn
      {"ts":"2025-12-12T01:44:46.778Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":1,"code":14}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)
    console.warn
      {"ts":"2025-12-12T01:44:46.782Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.retry","subject":"internal.ingress.v1","attempt":2,"code":14}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:78:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:79:17)
    console.warn
      {"ts":"2025-12-12T01:44:46.785Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"ingress.publish.no_retry_on_timeout","subject":"dev.internal.ingress.v1","attempt":1,"code":4,"reason":"publish_timeout"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.shouldRetry (src/services/ingress/twitch/publisher.ts:67:18)
      at withBackoff (src/common/retry.ts:41:37)
      at TwitchIngressPublisher.publish (src/services/ingress/twitch/publisher.ts:48:17)
      at Object.<anonymous> (src/services/ingress/twitch/publisher.spec.ts:102:5)
PASS tools/brat/src/lb/importer/__tests__/importer.guard.test.ts
PASS src/services/routing/routing.slip.test.ts
PASS tools/brat/src/providers/gcp/cloudrun.spec.ts
PASS tests/services/message-bus/pubsub-batching.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:47.062Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:47.062Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"internal.test.v1","batching":{"maxMessages":100,"maxMilliseconds":1500},"ensureMode":"off","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
PASS tests/services/message-bus/nats-attributes.spec.ts
PASS tools/brat/src/providers/cdktf-synth.connectors.spec.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS tools/brat/src/providers/cdktf-synth.spec.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS tests/common/publisher-manager.spec.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:47.164Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:47.166Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
    console.warn
      {"ts":"2025-12-12T01:44:47.166Z","service":"bitbrat","level":"warn","severity":"WARNING","msg":"publisher.manager.flush.error","error":"boom"}
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      136 |     if (!this.shouldLog('warn')) return;
    > 137 |     console.warn(JSON.stringify(this.base({ level: 'warn', severity: this.severityOf('warn'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      138 |   }
      139 |
      140 |   info(msg: string, context?: Record<string, unknown>) {
      at Logger.warn (src/common/logging.ts:137:13)
      at Object.flushAll (src/common/resources/publisher-manager.ts:33:15)
      at Object.<anonymous> (tests/common/publisher-manager.spec.ts:40:5)
    console.log
      {"ts":"2025-12-12T01:44:47.166Z","service":"bitbrat","level":"info","severity":"INFO","msg":"publisher.manager.setup"}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/llm-bot/__tests__/prompt-composer.spec.ts
PASS tools/brat/src/lb/importer/__tests__/importer.test.ts
PASS tests/services/command-processor/candidate-create.spec.ts
PASS tests/services/egress/selection.test.ts
PASS tools/brat/src/config/schema.routing.test.ts
PASS src/services/message-bus/__tests__/pubsub-publisher-logging.test.ts
  ‚óè Console
    console.log
      {"ts":"2025-12-12T01:44:47.619Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:47.619Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"off","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:47.620Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.client.init","apiEndpoint":"default","projectId":"auto"}
      at Logger.info (src/common/logging.ts:142:13)
    console.log
      {"ts":"2025-12-12T01:44:47.620Z","service":"bitbrat","level":"info","severity":"INFO","msg":"pubsub.publisher.init","topic":"test.topic","batching":{"maxMessages":100,"maxMilliseconds":20},"ensureMode":"off","publishTimeoutMs":0}
      at Logger.info (src/common/logging.ts:142:13)
PASS src/services/routing/routing.dlq.test.ts
  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{"ts":"2025-12-12T01:44:47.758Z","service":"command-processor","level":"error","severity":"ERROR","msg":"regex_cache.snapshot.error","error":"module.exports.v1 is not a constructor"}".
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at console.error (node_modules/@jest/console/build/BufferedConsole.js:127:10)
      at Logger.error (src/common/logging.ts:132:13)
      at QueryWatch.onError (src/services/command-processor/regex-cache.ts:147:14)
      at QueryWatch.closeStream (node_modules/@google-cloud/firestore/build/src/watch.js:227:18)
      at node_modules/@google-cloud/firestore/build/src/watch.js:342:18
PASS tools/brat/src/config/__tests__/allow-unauth.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS src/services/llm-bot/instance-memory.spec.ts
PASS tools/brat/src/providers/gcp/preflight.spec.ts
  ‚óè Console
    console.warn
      [preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.
      22 |     }
      23 |     // Local override: permit skipping checks for development
    > 24 |     console.warn('[preflight] --allow-no-vpc specified; skipping VPC/connector enforcement for local development.');
         |             ^
      25 |     return;
      26 |   }
      27 |
      at assertVpcPreconditions (tools/brat/src/providers/gcp/preflight.ts:24:13)
      at Object.<anonymous> (tools/brat/src/providers/gcp/preflight.spec.ts:32:40)
PASS src/services/router/__tests__/rule-loader.hardening.test.ts
  ‚óè Console
    console.error
      {"ts":"2025-12-12T01:44:47.935Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.warm_load_error","error":"emulator not available"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:161:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:12:5)
    console.error
      {"ts":"2025-12-12T01:44:47.936Z","service":"bitbrat","level":"error","severity":"ERROR","msg":"rule_loader.subscribe_error","error":"listen failed"}
      130 |   error(msg: string, context?: Record<string, unknown>) {
      131 |     if (!this.shouldLog('error')) return;
    > 132 |     console.error(JSON.stringify(this.base({ level: 'error', severity: this.severityOf('error'), msg, ...(this.sanitize(context) || {}) })));
          |             ^
      133 |   }
      134 |
      135 |   warn(msg: string, context?: Record<string, unknown>) {
      at Logger.error (src/common/logging.ts:132:13)
      at RuleLoader.start (src/services/router/rule-loader.ts:175:14)
      at Object.<anonymous> (src/services/router/__tests__/rule-loader.hardening.test.ts:26:5)
PASS tools/brat/src/providers/cdktf-synth.loadbalancer.routing.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS tools/brat/src/providers/cdktf-synth.lb.spec.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS tests/common/events/attributes.spec.ts
PASS tools/brat/src/providers/cdktf-synth.buckets.test.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":[],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS src/common/retry.test.ts
PASS tools/brat/src/providers/gcp/lb-preflight.spec.ts
PASS tools/brat/src/providers/gcp/cloudbuild-triggers.spec.ts
PASS tools/brat/src/orchestration/errors.spec.ts
PASS tools/brat/src/config/loader.spec.ts
  ‚óè Console
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
    console.log
      {"component":"brat","action":"config.interpolate","vars_used":["DOMAIN_SUFFIX","ENV_PREFIX"],"unresolved":[],"notice":"Set BITBRAT_INTERPOLATION=0 to disable interpolation temporarily"}
      at loadArchitecture (tools/brat/src/config/loader.ts:150:15)
PASS src/common/config.test.ts
PASS tools/brat/src/config/schema.network.spec.ts
PASS tests/services/message-bus/pubsub-attributes.spec.ts
PASS tests/services/message-bus/nats-logging.spec.ts
PASS tools/brat/src/providers/gcp/secrets.spec.ts
PASS tools/brat/src/config/schema.test.ts
PASS src/services/message-bus/message-bus.test.ts
PASS tools/brat/src/providers/gcp/cloudbuild.spec.ts
PASS tools/brat/src/providers/gcp/apis.spec.ts
PASS src/services/message-bus/__tests__/factory-selection.test.ts
PASS infrastructure/cdktf/network/config.spec.ts
PASS src/services/message-bus/__tests__/subscriber-options.test.ts
PASS tests/services/message-bus/normalize-attributes.spec.ts
PASS tools/brat/src/config/__tests__/resolve-services.scaling.test.ts
PASS src/services/llm-bot/__tests__/personality-resolver.spec.ts
PASS src/services/ingress/twitch/envelope-builder.spec.ts
PASS tests/common/retry.spec.ts
PASS tools/brat/src/config/schema.spec.ts
PASS src/services/router/__tests__/jsonlogic-evaluator.test.ts
PASS src/services/auth/__tests__/enrichment.spec.ts
PASS tests/services/message-bus/pubsub-logging.spec.ts
PASS tools/brat/src/lb/urlmap/__tests__/load-from-arch.test.ts
Summary of all failing tests
FAIL tools/brat/src/providers/cdktf-synth.network.spec.ts
  ‚óè cdktf synth network module ‚Ä∫ honors overlays: multi-region subnets and flow logs enabled with optional remote backend
    expect(received).toContain(expected) // indexOf
    Expected substring: "backend \"gcs\""
    Received string:    "# Synthesized by brat CDKTF synth (module: network)
    # This file was generated to provision the BitBrat Network using overlays.
    # module: network¬∑
    terraform {
      required_version = \">= 1.5.0\"
      required_providers {
        google = {
          source  = \"hashicorp/google\"
          version = \">= 5.0.0\"
        }
      }
    }¬∑
    provider \"google\" {
      project = var.project_id
      region  = var.region
    }¬∑
    variable \"project_id\" {
      type    = string
      default = \"proj-123\"
    }¬∑
    variable \"region\" {
      type    = string
      default = \"us-central1\"
    }¬∑
    variable \"environment\" {
      type    = string
      default = \"dev\"
    }¬∑
    locals {
      regions = [\"us-central1\", \"us-west1\"]
      subnets = {
        \"us-central1\" = { name = \"brat-subnet-us-central1-dev\", cidr = \"10.10.0.0/20\" },
        \"us-west1\" = { name = \"west-subnet\", cidr = \"10.20.0.0/20\" }
      }
    }¬∑
    # VPC
    resource \"google_compute_network\" \"vpc\" {
      name                    = \"brat-vpc\"
      auto_create_subnetworks = false
    }¬∑
    # Subnets with Private Google Access (per region)
    resource \"google_compute_subnetwork\" \"subnet\" {
      for_each                 = local.subnets
      name                     = each.value.name
      ip_cidr_range            = each.value.cidr
      region                   = each.key
      network                  = google_compute_network.vpc.id
      private_ip_google_access = true¬∑
      log_config {
        aggregation_interval = \"INTERVAL_5_MIN\"
        flow_sampling        = 0.5
        metadata             = \"INCLUDE_ALL\"
      }
    }¬∑
    # Cloud Routers (per region)
    resource \"google_compute_router\" \"router\" {
      for_each = toset(local.regions)
      name     = \"brat-router-${each.key}\"
      region   = each.key
      network  = google_compute_network.vpc.id
    }¬∑
    ## Cloud NAT removed to reduce latency. Public egress should use Cloud Run default path.
    ## When using Serverless VPC Access, set egress to \"Private ranges only\" so public
    ## traffic (e.g., Pub/Sub APIs) bypasses the connector.¬∑
    # Firewall: allow-internal
    resource \"google_compute_firewall\" \"allow_internal\" {
      name    = \"allow-internal\"
      network = google_compute_network.vpc.name
      allow {
        protocol = \"icmp\"
      }
      allow {
        protocol = \"tcp\"
        ports    = [\"0-65535\"]
      }
      allow {
        protocol = \"udp\"
        ports    = [\"0-65535\"]
      }
      source_ranges = [
        \"10.0.0.0/8\",
        \"172.16.0.0/12\",
        \"192.168.0.0/16\",
      ]
    }¬∑
    # Firewall: allow-health-checks
    resource \"google_compute_firewall\" \"allow_health_checks\" {
      name    = \"allow-health-checks\"
      network = google_compute_network.vpc.name
      allow {
        protocol = \"tcp\"
        ports    = [\"80\", \"443\"]
      }
      source_ranges = [
        \"35.191.0.0/16\",
        \"130.211.0.0/22\",
      ]
    }¬∑
    # Outputs for downstream stacks
    output \"vpcSelfLink\" {
      description = \"Self link for the created VPC\"
      value       = google_compute_network.vpc.self_link
    }¬∑
    output \"subnetSelfLinkByRegion\" {
      description = \"Map of region to subnet selfLink\"
      value       = { for r, s in google_compute_subnetwork.subnet : r => s.self_link }
    }¬∑
    output \"routersByRegion\" {
      description = \"Map of region to router name\"
      value       = { for r, s in google_compute_router.router : r => s.name }
    }¬∑
    ## NAT outputs removed
    "
      57 |
      58 |     // backend block from remoteState (CI not set in test)
    > 59 |     expect(mainTf).toContain('backend "gcs"');
         |                    ^
      60 |     expect(mainTf).toContain('bucket = "tf-state-bucket"');
      61 |     expect(mainTf).toContain('prefix = "network/dev"');
      62 |
      at Object.<anonymous> (tools/brat/src/providers/cdktf-synth.network.spec.ts:59:20)
Test Suites: 1 failed, 2 skipped, 132 passed, 133 of 135 total
Tests:       1 failed, 10 skipped, 346 passed, 357 total
Snapshots:   2 passed, 2 total
Time:        17.957 s, estimated 73 s
Ran all test suites.
